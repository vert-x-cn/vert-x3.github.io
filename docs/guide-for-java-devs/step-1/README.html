<!DOCTYPE html>
<html lang="en">
<head>
  <title>A minimally viable wiki written with Vert.x - Vert.x</title>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta content="width=device-width, initial-scale=1.0" name="viewport">
  <meta content="Eclipse Vert.x is a tool-kit for building reactive applications on the JVM." name="description">
  <link href="https://okou19900722.gitee.io/cn.vertx.tk//stylesheets/docs.css" media="screen" rel="stylesheet">
  <link href="https://okou19900722.gitee.io/cn.vertx.tk//stylesheets/font-awesome.min.css" media="screen" rel="stylesheet">
  <link href="https://okou19900722.gitee.io/cn.vertx.tk//javascripts/styles/rainbow.min.css" media="screen" rel="stylesheet">
  <!-- IE 6-8 support of HTML 5 elements -->
  <!--[if lt IE 9]>
  <script src="http://static.jboss.org/theme/js/libs/html5/pre3.6/html5.min.js"></script>
  <![endif]-->

  <link rel="apple-touch-icon" sizes="57x57" href="https://okou19900722.gitee.io/cn.vertx.tk//assets/favicons/vertx-favicon-7/apple-touch-icon-57x57.png">
  <link rel="apple-touch-icon" sizes="60x60" href="https://okou19900722.gitee.io/cn.vertx.tk//assets/favicons/vertx-favicon-7/apple-touch-icon-60x60.png">
  <link rel="apple-touch-icon" sizes="72x72" href="https://okou19900722.gitee.io/cn.vertx.tk//assets/favicons/vertx-favicon-7/apple-touch-icon-72x72.png">
  <link rel="apple-touch-icon" sizes="76x76" href="https://okou19900722.gitee.io/cn.vertx.tk//assets/favicons/vertx-favicon-7/apple-touch-icon-76x76.png">
  <link rel="apple-touch-icon" sizes="114x114" href="https://okou19900722.gitee.io/cn.vertx.tk//assets/favicons/vertx-favicon-7/apple-touch-icon-114x114.png">
  <link rel="apple-touch-icon" sizes="120x120" href="https://okou19900722.gitee.io/cn.vertx.tk//assets/favicons/vertx-favicon-7/apple-touch-icon-120x120.png">
  <link rel="apple-touch-icon" sizes="144x144" href="https://okou19900722.gitee.io/cn.vertx.tk//assets/favicons/vertx-favicon-7/apple-touch-icon-144x144.png">
  <link rel="apple-touch-icon" sizes="152x152" href="https://okou19900722.gitee.io/cn.vertx.tk//assets/favicons/vertx-favicon-7/apple-touch-icon-152x152.png">
  <link rel="apple-touch-icon" sizes="180x180" href="https://okou19900722.gitee.io/cn.vertx.tk//assets/favicons/vertx-favicon-7/apple-touch-icon-180x180.png">
  <link rel="icon" type="image/png" href="https://okou19900722.gitee.io/cn.vertx.tk//assets/favicons/vertx-favicon-7/favicon-32x32.png" sizes="32x32">
  <link rel="icon" type="image/png" href="https://okou19900722.gitee.io/cn.vertx.tk//assets/favicons/vertx-favicon-7/android-chrome-192x192.png" sizes="192x192">
  <link rel="icon" type="image/png" href="https://okou19900722.gitee.io/cn.vertx.tk//assets/favicons/vertx-favicon-7/favicon-96x96.png" sizes="96x96">
  <link rel="icon" type="image/png" href="https://okou19900722.gitee.io/cn.vertx.tk//assets/favicons/vertx-favicon-7/favicon-16x16.png" sizes="16x16">
  <link rel="manifest" href="https://okou19900722.gitee.io/cn.vertx.tk//assets/favicons/vertx-favicon-7/manifest.json">
  <link rel="mask-icon" href="https://okou19900722.gitee.io/cn.vertx.tk//assets/favicons/vertx-favicon-7/safari-pinned-tab.svg" color="#5bbad5">
  <meta name="msapplication-TileColor" content="#7d3194">
  <meta name="msapplication-TileImage" content="https://okou19900722.gitee.io/cn.vertx.tk//assets/favicons/vertx-favicon-7/mstile-144x144.png">
  <meta name="theme-color" content="#ffffff">

  <link href="https://fonts.googleapis.com/css?family=Ubuntu:400,500,700,400italic" rel="stylesheet" type="text/css">
  <link rel="alternate" type="application/rss+xml" title="RSS"
     href="https://okou19900722.gitee.io/cn.vertx.tk//feed.xml">
  <script>
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
      (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
      m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
    ga('create', 'UA-30144458-1', 'auto');
    ga('create', 'UA-71153120-1', 'auto', 'tracker');
    ga('send', 'pageview');
    ga('tracker.send', 'pageview');
  </script>
  <style>
    .page-link-to-github {
      position: relative;
      z-index: 1;
      display: inline-block;
      border: 1px solid #782B90;
      border-radius: 5px;
      color: #782B90;
      font-size: 12px;
      padding: 4px 10px;
      text-decoration: none;
      background-color: #ffffff;
    }
    .page-link-to-github:hover {
      color: #ffffff;
      border-color: #ffffff;
      background-color: #782B90;
    }

    .page-link-to-github .github-icon {
      position: absolute;
      display: inline-block;
      width: 20px;
      height: 20px;
      /*background-position: -50px 0*/
      background: url('https://okou19900722.gitee.io/cn.vertx.tk//assets/github.png') no-repeat 0 0;
    }

    @media (-webkit-min-device-pixel-ratio: 2),(min-resolution:192dpi) {
      .page-link-to-github .github-icon {
        background-image:url('https://okou19900722.gitee.io/cn.vertx.tk//assets/github@2x.png');
        background-size: 150px auto
      }
    }

    .page-link-to-github:hover .github-icon {
      /*background-position: 0 0*/
      background-position: -100px 0
    }
    .text {
      text-decoration: underline
    }
    .page-link-to-github .text {
      padding-left: 27px
    }
    .text {
      padding-right: 8px
    }
    .page-link-to-github {
      float: right;
      top: 4px
    }

  </style>
</head>
<body>

<a href="http://www.reactivemanifesto.org/" id="reactive-manifesto-banner">
  <img style="border: 0; position: fixed; right: 0; top:0; z-index: 9000"
    src="https://d379ifj7s9wntv.cloudfront.net/reactivemanifesto/images/ribbons/we-are-reactive-black-right.png">
</a>

<a id="skippy" class="sr-only sr-only-focusable" href="#content"><div class="container"><span class="skiplink-text">Skip to main content</span></div></a>

<header class="navbar navbar-default navbar-static-top" id="top" role="banner">
  <div class="container">
    <div class="navbar-header">
      <button class="navbar-toggle collapsed" type="button" data-toggle="collapse" data-target="#vertx-navbar-collapse">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <a href="https://okou19900722.gitee.io/cn.vertx.tk//" class="navbar-brand"><img alt="Brand" src="https://okou19900722.gitee.io/cn.vertx.tk//assets/logo-sm.png"></a>
    </div>
    <nav class="collapse navbar-collapse" id="vertx-navbar-collapse">
      <ul class="nav navbar-nav navbar-right">
        <li><a href="http://start.vertx.io">Starter</a></li>
        <li><a href="https://vertx.io">官网</a></li>
        <li><a href="https://okou19900722.gitee.io/cn.vertx.tk//download/">下载</a></li>
        <li><a href="https://okou19900722.gitee.io/cn.vertx.tk//docs/">文档</a></li>
        <li><a href="https://github.com/vert-x3/wiki/wiki">维基</a></li>
        <li><a href="https://okou19900722.gitee.io/cn.vertx.tk//community/">社区</a></li>
        <li><a href="https://okou19900722.gitee.io/cn.vertx.tk//materials/">资料</a></li>
        <li><a href="https://okou19900722.gitee.io/cn.vertx.tk//blog/">博客</a></li>
      </ul>
    </nav>
  </div>
</header>



  <div class="page-header" id="content">
    <div class="container">
      <div class="row">
        <div class="col-sm-12">
          <h1>A minimally viable wiki written with Vert.x</h1>
          
        </div>
      </div>
    </div>
  </div>



<div id="content">
  <div class="container docs-content">
    <div class="row">
      <div class="col-sm-12 col-md-push-9 col-md-3 hidden-xs hidden-sm">
        <div id="sidebar" data-spy="affix">
          <ul class="sectlevel1">
<li><a href="#_bootstrapping_a_maven_project">Bootstrapping a Maven project</a></li>
<li><a href="#_adding_the_required_dependencies">Adding the required dependencies</a></li>
<li><a href="#_anatomy_of_a_verticle">Anatomy of a verticle</a></li>
<li><a href="#_a_word_on_vert_x_future_objects_and_callbacks">A word on Vert.x future objects and callbacks</a></li>
<li><a href="#_wiki_verticle_initialization_phases">Wiki verticle initialization phases</a>
<ul class="sectlevel2">
<li><a href="#_database_initialization">Database initialization</a></li>
<li><a href="#_notes_about_logging">Notes about logging</a></li>
<li><a href="#_http_server_initialization">HTTP server initialization</a></li>
</ul>
</li>
<li><a href="#_http_router_handlers">HTTP router handlers</a>
<ul class="sectlevel2">
<li><a href="#_index_page_handler">Index page handler</a></li>
<li><a href="#_wiki_page_rendering_handler">Wiki page rendering handler</a></li>
<li><a href="#_page_creation_handler">Page creation handler</a></li>
<li><a href="#_page_saving_handler">Page saving handler</a></li>
<li><a href="#_page_deletion_handler">Page deletion handler</a></li>
</ul>
</li>
<li><a href="#_running_the_application">Running the application</a></li>
</ul>
        </div>
      </div>
      <div class="col-sm-12 col-md-pull-3 col-md-9">
        <div class="toc hidden-md hidden-lg">
          <h2>Table of Contents</h2>
          <ul class="sectlevel1">
<li><a href="#_bootstrapping_a_maven_project">Bootstrapping a Maven project</a></li>
<li><a href="#_adding_the_required_dependencies">Adding the required dependencies</a></li>
<li><a href="#_anatomy_of_a_verticle">Anatomy of a verticle</a></li>
<li><a href="#_a_word_on_vert_x_future_objects_and_callbacks">A word on Vert.x future objects and callbacks</a></li>
<li><a href="#_wiki_verticle_initialization_phases">Wiki verticle initialization phases</a>
<ul class="sectlevel2">
<li><a href="#_database_initialization">Database initialization</a></li>
<li><a href="#_notes_about_logging">Notes about logging</a></li>
<li><a href="#_http_server_initialization">HTTP server initialization</a></li>
</ul>
</li>
<li><a href="#_http_router_handlers">HTTP router handlers</a>
<ul class="sectlevel2">
<li><a href="#_index_page_handler">Index page handler</a></li>
<li><a href="#_wiki_page_rendering_handler">Wiki page rendering handler</a></li>
<li><a href="#_page_creation_handler">Page creation handler</a></li>
<li><a href="#_page_saving_handler">Page saving handler</a></li>
<li><a href="#_page_deletion_handler">Page deletion handler</a></li>
</ul>
</li>
<li><a href="#_running_the_application">Running the application</a></li>
</ul>
        </div>

  <a href="https://github.com/okou19900722/vertx-web-site-translation-chinese/tree/master/vertx-translation-stack/guide-for-java-devs-translation"
     class="page-link-to-github"
     target="_blank"
     title="Edit this page on GitHub">
    <i class="github-icon"></i>
    <span class="text">编辑本页</span>
  </a>

        <div id="preamble">
<div class="sectionbody">
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<div class="title">Tip</div>
</td>
<td class="content">
The corresponding source code is in the <code>step-1</code> folder of the guide repository.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>We are going to start with a first iteration and the simplest code possible to have a wiki written with Vert.x.
While the next iterations will introduce more elegance into the code base as well as proper testing, we will see that quick prototyping with Vert.x is both a simple and a realistic target.</p>
</div>
<div class="paragraph">
<p>At this stage the wiki will use server-side rendering of HTML pages and data persistence through a JDBC connection.
To do so, we will use the following libraries.</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p><a href="http://vertx.io/docs/vertx-web/java/">Vert.x web</a> as while the Vert.x core library <em>does</em> support the creation of HTTP servers, it does not provide elegant APIs to deal with routing, handling of request payloads, etc.</p>
</li>
<li>
<p><a href="http://vertx.io/docs/vertx-jdbc-client/java/">Vert.x JDBC client</a> to provide an asynchronous API over JDBC.</p>
</li>
<li>
<p><a href="http://freemarker.org/">Apache FreeMarker</a> to render server-side pages as it is an uncomplicated template engine.</p>
</li>
<li>
<p><a href="https://github.com/rjeschke/txtmark">Txtmark</a> to render Markdown text to HTML, allowing the edition of wiki pages in Markdown.</p>
</li>
</ol>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_bootstrapping_a_maven_project">Bootstrapping a Maven project</h2>
<div class="sectionbody">
<div class="paragraph">
<p>This guide makes the choice of using <a href="https://maven.apache.org">Apache Maven</a> as the build tool, primarily because it is very well integrated with the major integrated development environments.
You can equally use another build tool such as <a href="https://gradle.org/">Gradle</a>.</p>
</div>
<div class="paragraph">
<p>The Vert.x community offers a template project structure from <a href="https://github.com/vert-x3/vertx-maven-starter" class="bare">https://github.com/vert-x3/vertx-maven-starter</a> that can be cloned.
Since you will likely want to use (Git) version control as well, the fastest route is to clone the repository, delete its <code>.git/</code> folder and then create a new Git repository:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>git clone https://github.com/vert-x3/vertx-maven-starter.git vertx-wiki
cd vertx-wiki
rm -rf .git
git init</pre>
</div>
</div>
<div class="paragraph">
<p>The project offers a sample verticle as well as a unit test.
You can safely delete all <code>.java</code> files beneath <code>src/</code> to hack on the wiki, but before doing so you may test that the project builds and runs successfully:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>mvn package exec:java</pre>
</div>
</div>
<div class="paragraph">
<p>You will notice that the Maven project <code>pom.xml</code> does 2 interesting things:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>it uses the <a href="https://maven.apache.org/plugins/maven-shade-plugin/">Maven Shade Plugin</a> to create a single Jar archive with all required dependencies, suffixed by <code>-fat.jar</code>, also called <em>"a fat Jar"</em>, and</p>
</li>
<li>
<p>it uses the <a href="http://www.mojohaus.org/exec-maven-plugin/">Exec Maven Plugin</a> to provide the <code>exec:java</code> goal that in turns starts the application through the Vert.x <code>io.vertx.core.Launcher</code> class. This is actually equivalent to running using the <code>vertx</code> command-line tool that ships in the Vert.x distribution.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>Finally, you will notice the presence of the <code>redeploy.sh</code> and <code>redeploy.bat</code> scripts that you can alternatively use for automatic compilation and redeployment upon code changes.
Note that doing so requires ensuring that the <code>VERTICLE</code> variable in these scripts matches the main verticle to be used.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
<div class="paragraph">
<p>Alternatively, the Fabric8 project hosts <a href="https://vmp.fabric8.io/">a Vert.x Maven plugin</a>.
It has goals to initialize, build, package and run a Vert.x project.</p>
</div>
<div class="paragraph">
<p>To generate a similar project as by cloning the Git starter repository:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>mkdir vertx-wiki
cd vertx-wiki
mvn io.fabric8:vertx-maven-plugin:1.0.13:setup -DvertxVersion=3.5.2
git init</pre>
</div>
</div>
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_adding_the_required_dependencies">Adding the required dependencies</h2>
<div class="sectionbody">
<div class="paragraph">
<p>The first batch of dependencies to add to the Maven <code>pom.xml</code> file are those for the web processing and rendering:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-xml" data-lang="xml">&lt;dependency&gt;
  &lt;groupId&gt;io.vertx&lt;/groupId&gt;
  &lt;artifactId&gt;vertx-web&lt;/artifactId&gt;
&lt;/dependency&gt;
&lt;dependency&gt;
  &lt;groupId&gt;io.vertx&lt;/groupId&gt;
  &lt;artifactId&gt;vertx-web-templ-freemarker&lt;/artifactId&gt;
&lt;/dependency&gt;
&lt;dependency&gt;
  &lt;groupId&gt;com.github.rjeschke&lt;/groupId&gt;
  &lt;artifactId&gt;txtmark&lt;/artifactId&gt;
  &lt;version&gt;0.13&lt;/version&gt;
&lt;/dependency&gt;</code></pre>
</div>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<div class="title">Tip</div>
</td>
<td class="content">
As the <code>vertx-web-templ-freemarker</code> name suggests, Vert.x web provides pluggable support for popular template engines: Handlebars, Jade, MVEL, Pebble, Thymeleaf and of course Freemarker.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The second set of dependencies are those required for JDBC database access:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-xml" data-lang="xml">&lt;dependency&gt;
  &lt;groupId&gt;io.vertx&lt;/groupId&gt;
  &lt;artifactId&gt;vertx-jdbc-client&lt;/artifactId&gt;
&lt;/dependency&gt;
&lt;dependency&gt;
  &lt;groupId&gt;org.hsqldb&lt;/groupId&gt;
  &lt;artifactId&gt;hsqldb&lt;/artifactId&gt;
  &lt;version&gt;2.3.4&lt;/version&gt;
&lt;/dependency&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>The Vert.x JDBC client library provides access to any JDBC-compliant database, but of course our project needs to have a JDBC driver on the <em>classpath</em>.</p>
</div>
<div class="paragraph">
<p><a href="http://hsqldb.org/">HSQLDB</a> is well-known relational database that is written in Java.
It is quite popular when used as an embedded database to avoid the requirement of having a third-party database server running separately.
It is also popular for unit and integration testing as it offers a (volatile) in-memory storage.</p>
</div>
<div class="paragraph">
<p>HSQLDB as an embedded database is a good fit to get us started.
It stores data in local files, and since the HSQLDB library Jar provides a JDBC driver the Vert.x JDBC configuration will be straightforward.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
<div class="paragraph">
<p>Vert.x also offers dedicated <a href="http://vertx.io/docs/vertx-mysql-postgresql-client/java/">MySQL and PostgreSQL client</a> libraries.</p>
</div>
<div class="paragraph">
<p>Of course you can use the general-purpose Vert.x JDBC client to connect to MySQL or PostgreSQL databases, but these libraries offers better performance by working with these 2 database server network protocols rather than going through the (blocking) JDBC APIs.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
Vert.x also provides libraries to deal with the popular non-relational databases <a href="http://vertx.io/docs/vertx-mongo-client/java/">MongoDB</a> and <a href="http://vertx.io/docs/vertx-redis-client/java/">Redis</a>.
The larger community offers integration with other storage systems like Apache Cassandra, OrientDB or ElasticSearch.
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_anatomy_of_a_verticle">Anatomy of a verticle</h2>
<div class="sectionbody">
<div class="paragraph">
<p>The verticle for our wiki consists of a single <code>io.vertx.guides.wiki.MainVerticle</code> Java class.
This class extends <code>io.vertx.core.AbstractVerticle</code>, the base class for verticles that mainly provides:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>life-cycle <code>start</code> and <code>stop</code> methods to override,</p>
</li>
<li>
<p>a <em>protected</em> field called <code>vertx</code> that references the Vert.x environment where the verticle is being deployed,</p>
</li>
<li>
<p>an accessor to some configuration object that allows passing external configuration to a verticle.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>To get started our verticle can just override the <code>start</code> method as follows:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">public class MainVerticle extends AbstractVerticle {

  @Override
  public void start(Future&lt;Void&gt; startFuture) throws Exception {
    startFuture.complete();
  }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>There are 2 forms of <code>start</code> (and <code>stop</code>) methods: 1 with no argument and 1 with a <em>future</em> object reference.
The no-argument variants imply that the verticle initialization or house-keeping phases always succeed unless an exception is being thrown.
The variants with a <em>future</em> object provide a more fine-grained approach to <em>eventually</em> signal that operations succeeded or not.
Indeed, some initialization or cleanup code may require asynchronous operations, so reporting via a <em>future</em> object naturally fits with asynchronous idioms.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_a_word_on_vert_x_future_objects_and_callbacks">A word on Vert.x future objects and callbacks</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Vert.x futures are not JDK futures: they can be composed and queried in a non-blocking fashion.
They shall be used for simple coordination of asynchronous tasks, and especially those of deploying verticles and checking if they were successfully deployed or not.</p>
</div>
<div class="paragraph">
<p>The Vert.x core APIs are based on callbacks to notify of asynchronous events.
The seasoned developer will naturally think that this opens the door to the so-called <em>"callback hell"</em> where multiple levels of nested callbacks render the code difficult to comprehend as illustrated by this fictional code:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">foo.a(1, res1 -&gt; {
  if (res1.succeeded()) {
    bar.b("abc", 1, res2 -&gt; {
      if (res.succeeded()) {
         baz.c(res3 -&gt; {
           dosomething(res1, res2, res3, res4 -&gt; {
               // (...)
           });
         });
      }
    });
  }
});</code></pre>
</div>
</div>
<div class="paragraph">
<p>While the core APIs could have been designed to favor promises and futures, the choice of callbacks is actually interesting since it allows different programming abstractions to be used.
Vert.x is a largely un-opinionated project, and callbacks allow the implementation of different models that better cope with asynchronous programming: reactive extensions (via RxJava), promises and futures, fibers (using bytecode instrumentation), etc.</p>
</div>
<div class="paragraph">
<p>Since all Vert.x APIs are callback-oriented before other abstractions like RxJava can be leveraged, this guide only uses callbacks in the first sections to ensure that the reader gets familiar with the core concepts in Vert.x.
It is also arguably easier to start with callbacks to draw a line between the many sections of asynchronous code.
Once it becomes evident in the sample code that callbacks do not always lead to easily readable code, we will introduce the RxJava support to show how the same asynchronous code can be better expressed by thinking in streams of processed events.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_wiki_verticle_initialization_phases">Wiki verticle initialization phases</h2>
<div class="sectionbody">
<div class="paragraph">
<p>To get our wiki running, we need to perform a 2-phases initialization:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>we need to establish a JDBC database connection, and also make sure that the database schema is in place, and</p>
</li>
<li>
<p>we need to start a HTTP server for the web application.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>Each phase can fail (e.g., the HTTP server TCP port is already being used), and they should not run in parallel as the web application code first needs the database access to work.</p>
</div>
<div class="paragraph">
<p>To make our code <em>cleaner</em> we will define 1 method per phase, and adopt a pattern of returning a <em>future / promise</em> object to notify when each of the phases completes, and whether it did so successfully or not:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">private Future&lt;Void&gt; prepareDatabase() {
  Future&lt;Void&gt; future = Future.future();
  // (...)
  return future;
}

private Future&lt;Void&gt; startHttpServer() {
  Future&lt;Void&gt; future = Future.future();
  // (...)
  return future;
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>By having each method returning a <em>future</em> object, the implementation of the <code>start</code> method becomes a composition:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">@Override
public void start(Future&lt;Void&gt; startFuture) throws Exception {
  Future&lt;Void&gt; steps = prepareDatabase().compose(v -&gt; startHttpServer());
  steps.setHandler(startFuture.completer());
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>When the <em>future</em> of <code>prepareDatabase</code> completes successfully, then <code>startHttpServer</code> is called and the <code>steps</code> future completes depending of the outcome of the future returned by <code>startHttpServer</code>.
<code>startHttpServer</code> is never called if <code>prepareDatabase</code> encounters an error, in which case the <code>steps</code> <em>future</em> is in a <em>failed</em> state and becomes completed with the exception describing the error.</p>
</div>
<div class="paragraph">
<p>Eventually <code>steps</code> completes: <code>setHandler</code> defines a handler to be called upon completion.
In our case we simply want to complete <code>startFuture</code> with <code>steps</code> and use the <code>completer</code> method to obtain a handler.
This is equivalent to:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">Future&lt;Void&gt; steps = prepareDatabase().compose(v -&gt; startHttpServer());
steps.setHandler(ar -&gt; {  <b class="conum">(1)</b>
  if (ar.succeeded()) {
    startFuture.complete();
  } else {
    startFuture.fail(ar.cause());
  }
});</code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p><code>ar</code> is of type <code>AsyncResult&lt;Void&gt;</code>.
<code>AsyncResult&lt;T&gt;</code> is used to pass the result of an asynchronous processing and may either yield a value of type <code>T</code> on success or a failure exception if the processing failed.</p>
</li>
</ol>
</div>
<div class="sect2">
<h3 id="_database_initialization">Database initialization</h3>
<div class="paragraph">
<p>The wiki database schema consists of a single table <code>Pages</code> with the following columns:</p>
</div>
<table class="tableblock frame-all grid-all spread">
<colgroup>
<col style="width: 33.3333%;">
<col style="width: 33.3333%;">
<col style="width: 33.3334%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Column</th>
<th class="tableblock halign-left valign-top">Type</th>
<th class="tableblock halign-left valign-top">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>Id</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Integer</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Primary key</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>Name</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Characters</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Name of a wiki page, must be unique</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>Content</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Text</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Markdown text of a wiki page</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>The database operations will be typical <em>create, read, update, delete</em> operations.
To get us started, we simply store the corresponding SQL queries as static fields of the <code>MainVerticle</code> class.
Note that they are written in a SQL dialect that HSQLDB understands, but that other relational databases may not necessarily support:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">private static final String SQL_CREATE_PAGES_TABLE = "create table if not exists Pages (Id integer identity primary key, Name varchar(255) unique, Content clob)";
private static final String SQL_GET_PAGE = "select Id, Content from Pages where Name = ?"; <b class="conum">(1)</b>
private static final String SQL_CREATE_PAGE = "insert into Pages values (NULL, ?, ?)";
private static final String SQL_SAVE_PAGE = "update Pages set Content = ? where Id = ?";
private static final String SQL_ALL_PAGES = "select Name from Pages";
private static final String SQL_DELETE_PAGE = "delete from Pages where Id = ?";</code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>The <code>?</code> in the queries are placeholders to pass data when executing queries, and the Vert.x JDBC client prevents from SQL injections.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>The application verticle needs to keep a reference to a <code>JDBCClient</code> object (from the <code>io.vertx.ext.jdbc</code> package) that serves as the connection to the database.
We do so using a field in <code>MainVerticle</code>, and we also create a general-purpose logger from the <code>org.slf4j</code> package:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">private JDBCClient dbClient;

private static final Logger LOGGER = LoggerFactory.getLogger(MainVerticle.class);</code></pre>
</div>
</div>
<div class="paragraph">
<p>Last but not least, here is the complete implementation of the <code>prepareDatabase</code> method.
It attempts to obtain a JDBC client connection, then performs a SQL query to create the <code>Pages</code> table unless it already exists:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">private Future&lt;Void&gt; prepareDatabase() {
  Future&lt;Void&gt; future = Future.future();

  dbClient = JDBCClient.createShared(vertx, new JsonObject()  <b class="conum">(1)</b>
    .put("url", "jdbc:hsqldb:file:db/wiki")   <b class="conum">(2)</b>
    .put("driver_class", "org.hsqldb.jdbcDriver")   <b class="conum">(3)</b>
    .put("max_pool_size", 30));   <b class="conum">(4)</b>

  dbClient.getConnection(ar -&gt; {    <b class="conum">(5)</b>
    if (ar.failed()) {
      LOGGER.error("Could not open a database connection", ar.cause());
      future.fail(ar.cause());    <b class="conum">(6)</b>
    } else {
      SQLConnection connection = ar.result();   <b class="conum">(7)</b>
      connection.execute(SQL_CREATE_PAGES_TABLE, create -&gt; {
        connection.close();   <b class="conum">(8)</b>
        if (create.failed()) {
          LOGGER.error("Database preparation error", create.cause());
          future.fail(create.cause());
        } else {
          future.complete();  <b class="conum">(9)</b>
        }
      });
    }
  });

  return future;
}</code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p><code>createShared</code> creates a shared connection to be shared among verticles known to the <code>vertx</code> instance, which in general is a good thing.</p>
</li>
<li>
<p>The JDBC client connection is made by passing a Vert.x JSON object. Here <code>url</code> is the JDBC URL.</p>
</li>
<li>
<p>Just like <code>url</code>, <code>driver_class</code> is specific to the JDBC driver being used and points to the driver class.</p>
</li>
<li>
<p><code>max_pool_size</code> is the number of concurrent connections. We chose 30 here, but it is just an arbitrary number.</p>
</li>
<li>
<p>Getting a connection is an asynchronous operation that gives us an <code>AsyncResult&lt;SQLConnection&gt;</code>. It must then be tested to see if the connection could be established or not (<code>AsyncResult</code> is actually a super-interface of <code>Future</code>).</p>
</li>
<li>
<p>If the SQL connection could not be obtained, then the method <em>future</em> is completed to fail with the <code>AsyncResult</code>-provided exception via the <code>cause</code> method.</p>
</li>
<li>
<p>The <code>SQLConnection</code> is the result of the successful <code>AsyncResult</code>. We can use it to perform a SQL query.</p>
</li>
<li>
<p>Before checking whether the SQL query succeeded or not, we must release it by calling <code>close</code>, otherwise the JDBC client connection pool can eventually drain.</p>
</li>
<li>
<p>We complete the method <em>future</em> object with a success.</p>
</li>
</ol>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<div class="title">Tip</div>
</td>
<td class="content">
The SQL database modules supported by the Vert.x project do not currently offer anything beyond passing SQL queries (e.g., an object-relational mapper) as they focus on providing asynchronous access to databases.
However, nothing forbids using <a href="https://github.com/vert-x3/vertx-awesome">more advanced modules from the community</a>, and we especially recommend checking out projects like <a href="https://github.com/jklingsporn/vertx-jooq">this jOOq generator for Vert.x</a> or <a href="https://github.com/BraintagsGmbH/vertx-pojo-mapper">this POJO mapper</a>.
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="_notes_about_logging">Notes about logging</h3>
<div class="paragraph">
<p>The previous subsection introduced a logger, and we opted for the <a href="https://www.slf4j.org/">SLF4J library</a>.
Vert.x is also unopinionated on logging: you can choose any popular Java logging library.
We recommend SLF4J since it is a popular logging abstraction and unification library in the Java ecosystem.</p>
</div>
<div class="paragraph">
<p>We also recommend using <a href="https://logback.qos.ch/">Logback</a> as a logger implementation.
Integrating both SLF4J and Logback can be done by adding two dependencies, or just <code>logback-classic</code> that points to both libraries (incidentally they are from the same author):</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-xml" data-lang="xml">&lt;dependency&gt;
  &lt;groupId&gt;ch.qos.logback&lt;/groupId&gt;
  &lt;artifactId&gt;logback-classic&lt;/artifactId&gt;
  &lt;version&gt;1.2.3&lt;/version&gt;
&lt;/dependency&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>By default SLF4J outputs many log events to the console from Vert.x, Netty, C3PO and the wiki application.
We can reduce the verbosity by adding the a <code>src/main/resources/logback.xml</code> configuration file (see <a href="https://logback.qos.ch/" class="bare">https://logback.qos.ch/</a> for more details):</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-xml" data-lang="xml">&lt;configuration&gt;

  &lt;appender name="STDOUT" class="ch.qos.logback.core.ConsoleAppender"&gt;
    &lt;encoder&gt;
      &lt;pattern&gt;%d{HH:mm:ss.SSS} [%thread] %-5level %logger{36} - %msg%n&lt;/pattern&gt;
    &lt;/encoder&gt;
  &lt;/appender&gt;

  &lt;logger name="com.mchange.v2" level="warn"/&gt;
  &lt;logger name="io.netty" level="warn"/&gt;
  &lt;logger name="io.vertx" level="info"/&gt;
  &lt;logger name="io.vertx.guides.wiki" level="debug"/&gt;

  &lt;root level="debug"&gt;
    &lt;appender-ref ref="STDOUT"/&gt;
  &lt;/root&gt;

&lt;/configuration&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>Last but not least HSQLDB does not integrate well with loggers when embedded.
By default it tries to reconfigure the logging system in place, so we need to disable it by passing a <code>-Dhsqldb.reconfig_logging=false</code> property to the Java Virtual Machine when executing applications.</p>
</div>
</div>
<div class="sect2">
<h3 id="_http_server_initialization">HTTP server initialization</h3>
<div class="paragraph">
<p>The HTTP server makes use of the <code>vertx-web</code> project to easily define <em>dispatching routes</em> for incoming HTTP requests.
Indeed, the Vert.x core API allows to start HTTP servers and listen for incoming connections, but it does not provide any facility to, say, have different handlers depending on the requested URL or processing request bodies.
This is the role of a <em>router</em> as it dispatches requests to different processing handlers depending on the URL, the HTTP method, etc.</p>
</div>
<div class="paragraph">
<p>The initialization consists in setting up a <em>request router</em>, then starting the HTTP server:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">private Future&lt;Void&gt; startHttpServer() {
  Future&lt;Void&gt; future = Future.future();
  HttpServer server = vertx.createHttpServer();   <b class="conum">(1)</b>

  Router router = Router.router(vertx);   <b class="conum">(2)</b>
  router.get("/").handler(this::indexHandler);
  router.get("/wiki/:page").handler(this::pageRenderingHandler); <b class="conum">(3)</b>
  router.post().handler(BodyHandler.create());  <b class="conum">(4)</b>
  router.post("/save").handler(this::pageUpdateHandler);
  router.post("/create").handler(this::pageCreateHandler);
  router.post("/delete").handler(this::pageDeletionHandler);

  server
    .requestHandler(router::accept)   <b class="conum">(5)</b>
    .listen(8080, ar -&gt; {   <b class="conum">(6)</b>
      if (ar.succeeded()) {
        LOGGER.info("HTTP server running on port 8080");
        future.complete();
      } else {
        LOGGER.error("Could not start a HTTP server", ar.cause());
        future.fail(ar.cause());
      }
    });

  return future;
}</code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>The <code>vertx</code> context object provides methods to create HTTP servers, clients, TCP/UDP servers and clients, etc.</p>
</li>
<li>
<p>The <code>Router</code> class comes from <code>vertx-web</code>: <code>io.vertx.ext.web.Router</code>.</p>
</li>
<li>
<p>Routes have their own handlers, and they can be defined by URL and/or by HTTP method. For short handlers a Java lambda is an option, but for more elaborate handlers it is a good idea to reference private methods instead. Note that URLs can be parametric: <code>/wiki/:page</code> will match a request like <code>/wiki/Hello</code>, in which case a <code>page</code> parameter will be available with value <code>Hello</code>.</p>
</li>
<li>
<p>This makes all HTTP POST requests go through a first handler, here <code>io.vertx.ext.web.handler.BodyHandler</code>. This handler automatically decodes the body from the HTTP requests (e.g., form submissions), which can then be manipulated as Vert.x buffer objects.</p>
</li>
<li>
<p>The router object can be used as a HTTP server handler, which then dispatches to other handlers as defined above.</p>
</li>
<li>
<p>Starting a HTTP server is an asynchronous operation, so an <code>AsyncResult&lt;HttpServer&gt;</code> needs to be checked for success. By the way the <code>8080</code> parameter specifies the TCP port to be used by the server.</p>
</li>
</ol>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_http_router_handlers">HTTP router handlers</h2>
<div class="sectionbody">
<div class="paragraph">
<p>The HTTP router instance of the <code>startHttpServer</code> method points to different handlers based on URL patterns and HTTP methods.
Each handler deals with an HTTP request, performs a database query, and renders HTML from a FreeMarker template.</p>
</div>
<div class="sect2">
<h3 id="_index_page_handler">Index page handler</h3>
<div class="paragraph">
<p>The index page provides a list of pointers to all wiki entries and a field to create a new one:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="images/images/index.png" alt="Wiki index">
</div>
</div>
<div class="paragraph">
<p>The implementation is a straightforward <code>select *</code> SQL query where data is then passed to the FreeMarker engine to render the HTML response.</p>
</div>
<div class="paragraph">
<p>The <code>indexHandler</code> method code is as follows:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">private final FreeMarkerTemplateEngine templateEngine = FreeMarkerTemplateEngine.create();

private void indexHandler(RoutingContext context) {
  dbClient.getConnection(car -&gt; {
    if (car.succeeded()) {
      SQLConnection connection = car.result();
      connection.query(SQL_ALL_PAGES, res -&gt; {
        connection.close();

        if (res.succeeded()) {
          List&lt;String&gt; pages = res.result() <b class="conum">(1)</b>
            .getResults()
            .stream()
            .map(json -&gt; json.getString(0))
            .sorted()
            .collect(Collectors.toList());

          context.put("title", "Wiki home");  <b class="conum">(2)</b>
          context.put("pages", pages);
          templateEngine.render(context, "templates", "/index.ftl", ar -&gt; {   <b class="conum">(3)</b>
            if (ar.succeeded()) {
              context.response().putHeader("Content-Type", "text/html");
              context.response().end(ar.result());  <b class="conum">(4)</b>
            } else {
              context.fail(ar.cause());
            }
          });

        } else {
          context.fail(res.cause());  <b class="conum">(5)</b>
        }
      });
    } else {
      context.fail(car.cause());
    }
  });
}</code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>SQL query results are being returned as instances of <code>JsonArray</code> and <code>JsonObject</code>.</p>
</li>
<li>
<p>The <code>RoutingContext</code> instance can be used to put arbitrary key / value data that is then available from templates, or chained router handlers.</p>
</li>
<li>
<p>Rendering a template is an asynchronous operation that leads us to the usual <code>AsyncResult</code> handling pattern.</p>
</li>
<li>
<p>The <code>AsyncResult</code> contains the template rendering as a <code>String</code> in case of success, and we can end the HTTP response stream with the value.</p>
</li>
<li>
<p>In case of failure the <code>fail</code> method from <code>RoutingContext</code> provides a sensible way to return a HTTP 500 error to the HTTP client.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>FreeMarker templates shall be placed in the <code>src/main/resources/templates</code> folder.
The <code>index.ftl</code> template code is as follows:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-html" data-lang="html">&lt;#include "header.ftl"&gt;

&lt;div class="row"&gt;

  &lt;div class="col-md-12 mt-1"&gt;
    &lt;div class="float-xs-right"&gt;
      &lt;form class="form-inline" action="/create" method="post"&gt;
        &lt;div class="form-group"&gt;
          &lt;input type="text" class="form-control" id="name" name="name" placeholder="New page name"&gt;
        &lt;/div&gt;
        &lt;button type="submit" class="btn btn-primary"&gt;Create&lt;/button&gt;
      &lt;/form&gt;
    &lt;/div&gt;
    &lt;h1 class="display-4"&gt;${context.title}&lt;/h1&gt;
  &lt;/div&gt;

  &lt;div class="col-md-12 mt-1"&gt;
  &lt;#list context.pages&gt;
    &lt;h2&gt;Pages:&lt;/h2&gt;
    &lt;ul&gt;
      &lt;#items as page&gt;
        &lt;li&gt;&lt;a href="/wiki/${page}"&gt;${page}&lt;/a&gt;&lt;/li&gt;
      &lt;/#items&gt;
    &lt;/ul&gt;
  &lt;#else&gt;
    &lt;p&gt;The wiki is currently empty!&lt;/p&gt;
  &lt;/#list&gt;
  &lt;/div&gt;

&lt;/div&gt;

&lt;#include "footer.ftl"&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>Key / value data stored in the <code>RoutingContext</code> object is made available through the <code>context</code> FreeMarker variable.</p>
</div>
<div class="paragraph">
<p>Since lots of templates have common header and footers, we extracted the following code in <code>header.ftl</code> and <code>footer.ftl</code>:</p>
</div>
<div class="listingblock">
<div class="title"><code>header.ftl</code></div>
<div class="content">
<pre class="highlight"><code class="language-html" data-lang="html">&lt;!DOCTYPE html&gt;
&lt;html lang="en"&gt;
&lt;head&gt;
  &lt;meta charset="utf-8"&gt;
  &lt;meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"&gt;
  &lt;meta http-equiv="x-ua-compatible" content="ie=edge"&gt;
  &lt;link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0-alpha.5/css/bootstrap.min.css"
        integrity="sha384-AysaV+vQoT3kOAXZkl02PThvDr8HYKPZhNT5h/CXfBThSRXQ6jW5DO2ekP5ViFdi" crossorigin="anonymous"&gt;
  &lt;title&gt;${context.title} | A Sample Vert.x-powered Wiki&lt;/title&gt;
&lt;/head&gt;
&lt;body&gt;

&lt;div class="container"&gt;</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title"><code>footer.ftl</code></div>
<div class="content">
<pre class="highlight"><code class="language-html" data-lang="html">&lt;/div&gt; &lt;!-- .container --&gt;

&lt;script src="https://ajax.googleapis.com/ajax/libs/jquery/3.1.1/jquery.min.js"
        integrity="sha384-3ceskX3iaEnIogmQchP8opvBy3Mi7Ce34nWjpBIwVTHfGYWQS9jwHDVRnpKKHJg7"
        crossorigin="anonymous"&gt;&lt;/script&gt;
&lt;script src="https://cdnjs.cloudflare.com/ajax/libs/tether/1.3.7/js/tether.min.js"
        integrity="sha384-XTs3FgkjiBgo8qjEjBk0tGmf3wPrWtA6coPfQDfFEY8AnYJwjalXCiosYRBIBZX8"
        crossorigin="anonymous"&gt;&lt;/script&gt;
&lt;script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0-alpha.5/js/bootstrap.min.js"
        integrity="sha384-BLiI7JTZm+JWlgKa0M0kGRpJbF2J8q+qreVrKBC47e3K6BW78kGLrCkeRX6I9RoK"
        crossorigin="anonymous"&gt;&lt;/script&gt;

&lt;/body&gt;
&lt;/html&gt;</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_wiki_page_rendering_handler">Wiki page rendering handler</h3>
<div class="paragraph">
<p>This handler deals with HTTP GET requests to have wiki pages being rendered, as in:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="images/images/page.png" alt="Wiki page">
</div>
</div>
<div class="paragraph">
<p>The page also provides a button to edit the content in Markdown.
Instead of having a separate handler and template, we simply rely on JavaScript and CSS to toggle the editor on and off when the button is being clicked:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="images/images/edit.png" alt="Wiki editor">
</div>
</div>
<div class="paragraph">
<p>The <code>pageRenderingHandler</code> method code is the following:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">private static final String EMPTY_PAGE_MARKDOWN =
  "# A new page\n" +
    "\n" +
    "Feel-free to write in Markdown!\n";

private void pageRenderingHandler(RoutingContext context) {
  String page = context.request().getParam("page");   <b class="conum">(1)</b>

  dbClient.getConnection(car -&gt; {
    if (car.succeeded()) {

      SQLConnection connection = car.result();
      connection.queryWithParams(SQL_GET_PAGE, new JsonArray().add(page), fetch -&gt; {  <b class="conum">(2)</b>
        connection.close();
        if (fetch.succeeded()) {

          JsonArray row = fetch.result().getResults()
            .stream()
            .findFirst()
            .orElseGet(() -&gt; new JsonArray().add(-1).add(EMPTY_PAGE_MARKDOWN));
          Integer id = row.getInteger(0);
          String rawContent = row.getString(1);

          context.put("title", page);
          context.put("id", id);
          context.put("newPage", fetch.result().getResults().size() == 0 ? "yes" : "no");
          context.put("rawContent", rawContent);
          context.put("content", Processor.process(rawContent));  <b class="conum">(3)</b>
          context.put("timestamp", new Date().toString());

          templateEngine.render(context, "templates", "/page.ftl", ar -&gt; {
            if (ar.succeeded()) {
              context.response().putHeader("Content-Type", "text/html");
              context.response().end(ar.result());
            } else {
              context.fail(ar.cause());
            }
          });
        } else {
          context.fail(fetch.cause());
        }
      });

    } else {
      context.fail(car.cause());
    }
  });
}</code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>URL parameters (<code>/wiki/:page</code> here) can be accessed through the context request object.</p>
</li>
<li>
<p>Passing argument values to SQL queries is done using a <code>JsonArray</code>, with the elements in order of the <code>?</code> symbols in the SQL query.</p>
</li>
<li>
<p>The <code>Processor</code> class comes from the <em>txtmark</em> Markdown rendering library that we use.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>The <code>page.ftl</code> FreeMarker template code is as follows:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-html" data-lang="html">&lt;#include "header.ftl"&gt;

&lt;div class="row"&gt;

  &lt;div class="col-md-12 mt-1"&gt;
      &lt;span class="float-xs-right"&gt;
        &lt;a class="btn btn-outline-primary" href="/" role="button" aria-pressed="true"&gt;Home&lt;/a&gt;
        &lt;button class="btn btn-outline-warning" type="button" data-toggle="collapse"
                data-target="#editor" aria-expanded="false" aria-controls="editor"&gt;Edit&lt;/button&gt;
      &lt;/span&gt;
    &lt;h1 class="display-4"&gt;
      &lt;span class="text-muted"&gt;{&lt;/span&gt;
    ${context.title}
      &lt;span class="text-muted"&gt;}&lt;/span&gt;
    &lt;/h1&gt;
  &lt;/div&gt;

  &lt;div class="col-md-12 mt-1 clearfix"&gt;
  ${context.content}
  &lt;/div&gt;

  &lt;div class="col-md-12 collapsable collapse clearfix" id="editor"&gt;
    &lt;form action="/save" method="post"&gt;
      &lt;div class="form-group"&gt;
        &lt;input type="hidden" name="id" value="${context.id}"&gt;
        &lt;input type="hidden" name="title" value="${context.title}"&gt;
        &lt;input type="hidden" name="newPage" value="${context.newPage}"&gt;
        &lt;textarea class="form-control" id="markdown" name="markdown" rows="15"&gt;${context.rawContent}&lt;/textarea&gt;
      &lt;/div&gt;
      &lt;button type="submit" class="btn btn-primary"&gt;Save&lt;/button&gt;
    &lt;#if context.id != -1&gt;
      &lt;button type="submit" formaction="/delete" class="btn btn-danger float-xs-right"&gt;Delete&lt;/button&gt;
    &lt;/#if&gt;
    &lt;/form&gt;
  &lt;/div&gt;

  &lt;div class="col-md-12 mt-1"&gt;
    &lt;hr class="mt-1"&gt;
    &lt;p class="small"&gt;Rendered: ${context.timestamp}&lt;/p&gt;
  &lt;/div&gt;

&lt;/div&gt;

&lt;#include "footer.ftl"&gt;</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_page_creation_handler">Page creation handler</h3>
<div class="paragraph">
<p>The index page offers a field to create a new page, and its surrounding HTML form points to a URL that is being managed by this handler.
The strategy isn&#8217;t actually to create a new entry in the database, but simply to redirect to a wiki page URL with the name to create.
Since the wiki page doesn&#8217;t exist, the <code>pageRenderingHandler</code> method will use a default text for new pages, and a user can eventually create that page by editing and then saving it.</p>
</div>
<div class="paragraph">
<p>The handler is the <code>pageCreateHandler</code> method, and its implementation is a redirection through an HTTP 303 status code:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">private void pageCreateHandler(RoutingContext context) {
  String pageName = context.request().getParam("name");
  String location = "/wiki/" + pageName;
  if (pageName == null || pageName.isEmpty()) {
    location = "/";
  }
  context.response().setStatusCode(303);
  context.response().putHeader("Location", location);
  context.response().end();
}</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_page_saving_handler">Page saving handler</h3>
<div class="paragraph">
<p>The <code>pageUpdateHandler</code> method deals with HTTP POST requests when saving a wiki page.
This happens both when updating an existing page (issuing a SQL <code>update</code> query) or saving a new page (issuing a SQL <code>insert</code> query):</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">private void pageUpdateHandler(RoutingContext context) {
  String id = context.request().getParam("id");   <b class="conum">(1)</b>
  String title = context.request().getParam("title");
  String markdown = context.request().getParam("markdown");
  boolean newPage = "yes".equals(context.request().getParam("newPage"));  <b class="conum">(2)</b>

  dbClient.getConnection(car -&gt; {
    if (car.succeeded()) {
      SQLConnection connection = car.result();
      String sql = newPage ? SQL_CREATE_PAGE : SQL_SAVE_PAGE;
      JsonArray params = new JsonArray();   <b class="conum">(3)</b>
      if (newPage) {
        params.add(title).add(markdown);
      } else {
        params.add(markdown).add(id);
      }
      connection.updateWithParams(sql, params, res -&gt; {   <b class="conum">(4)</b>
        connection.close();
        if (res.succeeded()) {
          context.response().setStatusCode(303);    <b class="conum">(5)</b>
          context.response().putHeader("Location", "/wiki/" + title);
          context.response().end();
        } else {
          context.fail(res.cause());
        }
      });
    } else {
      context.fail(car.cause());
    }
  });
}</code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>Form parameters sent through a HTTP POST request are available from the <code>RoutingContext</code> object. Note that without a <code>BodyHandler</code> within the <code>Router</code> configuration chain these values would not be available, and the form submission payload would need to be manually decoded from the HTTP POST request payload.</p>
</li>
<li>
<p>We rely on a hidden form field rendered in the <code>page.ftl</code> FreeMarker template to know if we are updating an existing page or saving a new page.</p>
</li>
<li>
<p>Again, preparing the SQL query with parameters uses a <code>JsonArray</code> to pass values.</p>
</li>
<li>
<p>The <code>updateWithParams</code> method is used for <code>insert</code> / <code>update</code> / <code>delete</code> SQL queries.</p>
</li>
<li>
<p>Upon success, we simply redirect to the page that has been edited.</p>
</li>
</ol>
</div>
</div>
<div class="sect2">
<h3 id="_page_deletion_handler">Page deletion handler</h3>
<div class="paragraph">
<p>The implementation of the <code>pageDeletionHandler</code> method is straightforward: given a wiki entry identifier, it issues a <code>delete</code> SQL query then redirects to the wiki index page:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">private void pageDeletionHandler(RoutingContext context) {
  String id = context.request().getParam("id");
  dbClient.getConnection(car -&gt; {
    if (car.succeeded()) {
      SQLConnection connection = car.result();
      connection.updateWithParams(SQL_DELETE_PAGE, new JsonArray().add(id), res -&gt; {
        connection.close();
        if (res.succeeded()) {
          context.response().setStatusCode(303);
          context.response().putHeader("Location", "/");
          context.response().end();
        } else {
          context.fail(res.cause());
        }
      });
    } else {
      context.fail(car.cause());
    }
  });
}</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_running_the_application">Running the application</h2>
<div class="sectionbody">
<div class="paragraph">
<p>At this stage we have a working, self-contained wiki application.</p>
</div>
<div class="paragraph">
<p>To run it we first need to build it with Maven:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>$ mvn clean package</pre>
</div>
</div>
<div class="paragraph">
<p>Since the build produces a Jar with all required dependencies embedded (including Vert.x and a JDBC database), running the wiki is as simple as:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>$ java -jar target/wiki-step-1-1.3.0-SNAPSHOT-fat.jar</pre>
</div>
</div>
<div class="paragraph">
<p>You can then point your favorite web browser to <a href="http://localhost:8080/" class="bare">http://localhost:8080/</a> and enjoy using the wiki.</p>
</div>
</div>
</div>
        

        
          <div id="footer">
            <div id="footer-text">
              
                上次更新时间 2018-06-05 07:44:38 CST
              
              
            </div>
          </div>
        
      </div>
    </div>
  </div>
</div>

<footer>
  <div class="container">
    <div class="row">
      <div class="col-xs-4 col-sm-4 col-md-2 col-lg-2">
        <h2>Eclipse Vert.x</h2>
        <ul class="list-unstyled">
          <li><a href="https://okou19900722.gitee.io/cn.vertx.tk//">主页</a></li>
          <li><a href="https://okou19900722.gitee.io/cn.vertx.tk//download/">下载</a></li>
          <li><a href="https://okou19900722.gitee.io/cn.vertx.tk//docs/">文档</a></li>
          <li><a href="https://github.com/vert-x3/wiki/wiki">维基</a></li>
          <li><a href="https://okou19900722.gitee.io/cn.vertx.tk//blog/">博客</a></li>
        </ul>
      </div>
      <div class="col-xs-4 col-sm-4 col-md-2 col-lg-2">
        <h2>Community</h2>
        <ul class="list-unstyled">
          <li><a href="https://okou19900722.gitee.io/cn.vertx.tk//community/">帮助 &amp; 贡献者</a></li>
          <li><a href="https://okou19900722.gitee.io/cn.vertx.tk//materials/">学习资料</a></li>
          <li><a href="https://groups.google.com/forum/?fromgroups#!forum/vertx">User Group</a></li>
          <li><a href="https://groups.google.com/forum/?fromgroups#!forum/vertx-dev">Developer Group</a></li>
          <li><a href="//shang.qq.com/wpa/qunwpa?idkey=587f58cacb9557e3291b46098e0fe09427b98a1c0f866da23c04c2762bc7e2ad">QQ群</a></li>
        </ul>
      </div>
      <div class="col-xs-4 col-sm-4 col-md-2 col-lg-2">
        <h2>Eclipse</h2>
        <ul class="list-unstyled">
          <li><a href="http://www.eclipse.org/">Eclipse Foundation</a></li>
          <li><a href="https://eclipse.org/legal/privacy.php">Privacy Policy</a></li>
          <li><a href="https://eclipse.org/legal/termsofuse.php">Terms of Use</a></li>
          <li><a href="https://eclipse.org/legal/copyright.php">Copyright Agent</a></li>
          <li><a href="http://www.eclipse.org/legal">Legal Resources</a></li>
        </ul>
      </div>

      <div class="col-xs-12 col-sm-12 col-md-6 col-lg-6 copyright">
        <p>Eclipse Vert.x is open source and dual-licensed under the <a href="http://www.eclipse.org/legal/epl-v20.html">Eclipse Public License 2.0</a> and <a href="https://www.apache.org/licenses/LICENSE-2.0.html">Apache License 2.0</a>.</p>
        <p>This website is licensed under the <a href="http://creativecommons.org/licenses/by-sa/3.0/">CC BY-SA 3.0 License</a>.<br>
        Design by <a href="https://www.michel-kraemer.com">Michel Kr&auml;mer</a>.</p>
        <div class="row">
          <div class="col-sm-12 col-md-5 col-md-offset-1 col-lg-offset-2">
            <a href="http://eclipse.org">
            <img class="logo eclipse-logo" src="https://okou19900722.gitee.io/cn.vertx.tk//assets/eclipse_logo_grey_small.png" width="204" height="48">
            </a>
          </div>
          <div class="col-sm-12 col-md-5 col-md-offset-1 col-lg-offset-0">
            <a href="http://cloudbees.com">
            <img class="logo cloudbees-logo" src="https://okou19900722.gitee.io/cn.vertx.tk//assets/Button-Built-on-CB-1-grey.png" width="180" height="48">
           </a>
          </div>
          <div class="col-sm-12 col-md-5 col-md-offset-7 jprofiler">
            <a href="http://www.ej-technologies.com/products/jprofiler/overview.html"
            style="text-decoration:none">
            <img class="logo jprofiler-logo" src="https://okou19900722.gitee.io/cn.vertx.tk//assets/jprofiler-logo.png" width="48" height="48"><span class="jprofiler-logo">&nbsp; JPROFILER</span>
            </a>
          </div>
        </div>
      </div>
    </div>
  </div>
</footer>

<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
<script src="https://okou19900722.gitee.io/cn.vertx.tk//javascripts/bootstrap.min.js"></script>
<script src="https://okou19900722.gitee.io/cn.vertx.tk//javascripts/highlight.pack.js"></script>
<script>hljs.initHighlightingOnLoad();</script>



<script src="https://okou19900722.gitee.io/cn.vertx.tk//javascripts/sidebar.js"></script>


<link rel="stylesheet" type="text/css" href="//cdnjs.cloudflare.com/ajax/libs/cookieconsent2/3.0.3/cookieconsent.min.css" />
<script src="//cdnjs.cloudflare.com/ajax/libs/cookieconsent2/3.0.3/cookieconsent.min.js"></script>
<script>
window.addEventListener("load", function(){
window.cookieconsent.initialise({
  "palette": {
    "popup": {
      "background": "#64386b",
      "text": "#ffcdfd"
    },
    "button": {
      "background": "transparent",
      "text": "#f8a8ff",
      "border": "#f8a8ff"
    }
  },
  "content": {
    "message": "This website uses anonymous cookies to ensure we provide you the best experience. ",
    "link": "Opt out!",
    "href": "https://tools.google.com/dlpage/gaoptout/"
  }
})});
</script>
</body>
</html>

