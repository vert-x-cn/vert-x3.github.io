<!DOCTYPE html>
<html lang="en">
<head>
  <title>Infinispan Cluster Manager - Vert.x</title>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta content="width=device-width, initial-scale=1.0" name="viewport">
  <meta content="Eclipse Vert.x is a tool-kit for building reactive applications on the JVM." name="description">
  <link href="https://vertx.tk/stylesheets/docs.css" media="screen" rel="stylesheet">
  <link href="https://vertx.tk/stylesheets/font-awesome.min.css" media="screen" rel="stylesheet">
  <link href="https://vertx.tk/javascripts/styles/rainbow.min.css" media="screen" rel="stylesheet">
  <!-- IE 6-8 support of HTML 5 elements -->
  <!--[if lt IE 9]>
  <script src="http://static.jboss.org/theme/js/libs/html5/pre3.6/html5.min.js"></script>
  <![endif]-->

  <link rel="apple-touch-icon" sizes="57x57" href="https://vertx.tk/assets/favicons/vertx-favicon-7/apple-touch-icon-57x57.png">
  <link rel="apple-touch-icon" sizes="60x60" href="https://vertx.tk/assets/favicons/vertx-favicon-7/apple-touch-icon-60x60.png">
  <link rel="apple-touch-icon" sizes="72x72" href="https://vertx.tk/assets/favicons/vertx-favicon-7/apple-touch-icon-72x72.png">
  <link rel="apple-touch-icon" sizes="76x76" href="https://vertx.tk/assets/favicons/vertx-favicon-7/apple-touch-icon-76x76.png">
  <link rel="apple-touch-icon" sizes="114x114" href="https://vertx.tk/assets/favicons/vertx-favicon-7/apple-touch-icon-114x114.png">
  <link rel="apple-touch-icon" sizes="120x120" href="https://vertx.tk/assets/favicons/vertx-favicon-7/apple-touch-icon-120x120.png">
  <link rel="apple-touch-icon" sizes="144x144" href="https://vertx.tk/assets/favicons/vertx-favicon-7/apple-touch-icon-144x144.png">
  <link rel="apple-touch-icon" sizes="152x152" href="https://vertx.tk/assets/favicons/vertx-favicon-7/apple-touch-icon-152x152.png">
  <link rel="apple-touch-icon" sizes="180x180" href="https://vertx.tk/assets/favicons/vertx-favicon-7/apple-touch-icon-180x180.png">
  <link rel="icon" type="image/png" href="https://vertx.tk/assets/favicons/vertx-favicon-7/favicon-32x32.png" sizes="32x32">
  <link rel="icon" type="image/png" href="https://vertx.tk/assets/favicons/vertx-favicon-7/android-chrome-192x192.png" sizes="192x192">
  <link rel="icon" type="image/png" href="https://vertx.tk/assets/favicons/vertx-favicon-7/favicon-96x96.png" sizes="96x96">
  <link rel="icon" type="image/png" href="https://vertx.tk/assets/favicons/vertx-favicon-7/favicon-16x16.png" sizes="16x16">
  <link rel="manifest" href="https://vertx.tk/assets/favicons/vertx-favicon-7/manifest.json">
  <link rel="mask-icon" href="https://vertx.tk/assets/favicons/vertx-favicon-7/safari-pinned-tab.svg" color="#5bbad5">
  <meta name="msapplication-TileColor" content="#7d3194">
  <meta name="msapplication-TileImage" content="https://vertx.tk/assets/favicons/vertx-favicon-7/mstile-144x144.png">
  <meta name="theme-color" content="#ffffff">

  <link href="https://fonts.googleapis.com/css?family=Ubuntu:400,500,700,400italic" rel="stylesheet" type="text/css">
  <link rel="alternate" type="application/rss+xml" title="RSS"
     href="https://vertx.tk/feed.xml">
  <script>
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
      (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
      m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
    ga('create', 'UA-30144458-1', 'auto');
    ga('create', 'UA-71153120-1', 'auto', 'tracker');
    ga('send', 'pageview');
    ga('tracker.send', 'pageview');
  </script>
</head>
<body>

<a href="http://www.reactivemanifesto.org/" id="reactive-manifesto-banner">
  <img style="border: 0; position: fixed; right: 0; top:0; z-index: 9000"
    src="https://d379ifj7s9wntv.cloudfront.net/reactivemanifesto/images/ribbons/we-are-reactive-black-right.png">
</a>

<a id="skippy" class="sr-only sr-only-focusable" href="#content"><div class="container"><span class="skiplink-text">Skip to main content</span></div></a>

<header class="navbar navbar-default navbar-static-top" id="top" role="banner">
  <div class="container">
    <div class="navbar-header">
      <button class="navbar-toggle collapsed" type="button" data-toggle="collapse" data-target="#vertx-navbar-collapse">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <a href="https://vertx.tk/" class="navbar-brand"><img alt="Brand" src="https://vertx.tk/assets/logo-sm.png"></a>
    </div>
    <nav class="collapse navbar-collapse" id="vertx-navbar-collapse">
      <ul class="nav navbar-nav navbar-right">
        <li><a href="http://start.vertx.io">Starter</a></li>
        <li><a href="https://vertx.tk/download/">Download</a></li>
        <li><a href="https://vertx.tk/docs/">Documentation</a></li>
        <li><a href="https://github.com/vert-x3/wiki/wiki">Wiki</a></li>
        <li><a href="https://vertx.tk/community/">Community</a></li>
        <li><a href="https://vertx.tk/materials/">Materials</a></li>
        <li><a href="https://vertx.tk/blog/">Blog</a></li>
      </ul>
    </nav>
  </div>
</header>



  <div class="page-header" id="content">
    <div class="container">
      <div class="row">
        <div class="col-sm-12">
          <h1>Infinispan Cluster Manager</h1>
          
        </div>
      </div>
    </div>
  </div>



<div id="content">
  <div class="container docs-content">
    <div class="row">
      <div class="col-sm-12 col-md-push-9 col-md-3 hidden-xs hidden-sm">
        <div id="sidebar" data-spy="affix">
          <ul class="sectlevel1">
<li><a href="#_using_this_cluster_manager">Using this cluster manager</a></li>
<li><a href="#_configuring_this_cluster_manager">Configuring this cluster manager</a></li>
<li><a href="#_using_an_existing_infinispan_cache_manager">Using an existing Infinispan Cache Manager</a></li>
<li><a href="#_configuring_for_kubernetes">Configuring for Kubernetes</a>
<ul class="sectlevel2">
<li><a href="#_rolling_updates">Rolling updates</a></li>
</ul>
</li>
<li><a href="#_configuring_for_docker_compose">Configuring for Docker Compose</a></li>
<li><a href="#_trouble_shooting_clustering">Trouble shooting clustering</a>
<ul class="sectlevel2">
<li><a href="#_multicast_not_enabled_on_the_machine">Multicast not enabled on the machine.</a></li>
<li><a href="#_using_wrong_network_interface">Using wrong network interface</a></li>
<li><a href="#_using_a_vpn">Using a VPN</a></li>
<li><a href="#_when_multicast_is_not_available">When multicast is not available</a></li>
<li><a href="#_problems_with_ipv6">Problems with IPv6</a></li>
<li><a href="#_enabling_logging">Enabling logging</a></li>
</ul>
</li>
<li><a href="#_infinispan_logging">Infinispan logging</a></li>
<li><a href="#_jgroups_logging">JGroups logging</a></li>
<li><a href="#_shareddata_extensions">SharedData extensions</a>
<ul class="sectlevel2">
<li><a href="#_asyncmap_content_streams">AsyncMap content streams</a></li>
</ul>
</li>
</ul>
        </div>
      </div>
      <div class="col-sm-12 col-md-pull-3 col-md-9">
        <div class="toc hidden-md hidden-lg">
          <h2>Table of Contents</h2>
          <ul class="sectlevel1">
<li><a href="#_using_this_cluster_manager">Using this cluster manager</a></li>
<li><a href="#_configuring_this_cluster_manager">Configuring this cluster manager</a></li>
<li><a href="#_using_an_existing_infinispan_cache_manager">Using an existing Infinispan Cache Manager</a></li>
<li><a href="#_configuring_for_kubernetes">Configuring for Kubernetes</a>
<ul class="sectlevel2">
<li><a href="#_rolling_updates">Rolling updates</a></li>
</ul>
</li>
<li><a href="#_configuring_for_docker_compose">Configuring for Docker Compose</a></li>
<li><a href="#_trouble_shooting_clustering">Trouble shooting clustering</a>
<ul class="sectlevel2">
<li><a href="#_multicast_not_enabled_on_the_machine">Multicast not enabled on the machine.</a></li>
<li><a href="#_using_wrong_network_interface">Using wrong network interface</a></li>
<li><a href="#_using_a_vpn">Using a VPN</a></li>
<li><a href="#_when_multicast_is_not_available">When multicast is not available</a></li>
<li><a href="#_problems_with_ipv6">Problems with IPv6</a></li>
<li><a href="#_enabling_logging">Enabling logging</a></li>
</ul>
</li>
<li><a href="#_infinispan_logging">Infinispan logging</a></li>
<li><a href="#_jgroups_logging">JGroups logging</a></li>
<li><a href="#_shareddata_extensions">SharedData extensions</a>
<ul class="sectlevel2">
<li><a href="#_asyncmap_content_streams">AsyncMap content streams</a></li>
</ul>
</li>
</ul>
        </div>
        <div id="preamble">
<div class="sectionbody">
<div class="paragraph">
<p>This is a cluster manager implementation for Vert.x that uses <a href="http://infinispan.org/">Infinispan</a>.</p>
</div>
<div class="paragraph">
<p>This implementation is packaged inside:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-xml" data-lang="xml">&lt;dependency&gt;
 &lt;groupId&gt;io.vertx&lt;/groupId&gt;
 &lt;artifactId&gt;vertx-infinispan&lt;/artifactId&gt;
 &lt;version&gt;3.6.0-SNAPSHOT&lt;/version&gt;
&lt;/dependency&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>In Vert.x a cluster manager is used for various functions including:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Discovery and group membership of Vert.x nodes in a cluster</p>
</li>
<li>
<p>Maintaining cluster wide topic subscriber lists (so we know which nodes are interested in which event bus addresses)</p>
</li>
<li>
<p>Distributed Map support</p>
</li>
<li>
<p>Distributed Locks</p>
</li>
<li>
<p>Distributed Counters</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Cluster managers <strong>do not</strong> handle the event bus inter-node transport, this is done directly by Vert.x with TCP connections.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_using_this_cluster_manager">Using this cluster manager</h2>
<div class="sectionbody">
<div class="paragraph">
<p>If you are using Vert.x from the command line, the jar corresponding to this cluster manager (it will be named <code>vertx-infinispan-3.6.0-SNAPSHOT.jar</code>
should be in the <code>lib</code> directory of the Vert.x installation.</p>
</div>
<div class="paragraph">
<p>If you want clustering with this cluster manager in your Vert.x Maven or Gradle project then just add a dependency to
the artifact: <code>io.vertx:vertx-infinispan:3.6.0-SNAPSHOT</code> in your project.</p>
</div>
<div class="paragraph">
<p>If the jar is on your classpath as above then Vert.x will automatically detect this and use it as the cluster manager.
Please make sure you don&#8217;t have any other cluster managers on your classpath or Vert.x might
choose the wrong one.</p>
</div>
<div class="paragraph">
<p>You can also specify the cluster manager programmatically if you are embedding Vert.x by specifying it on the options
when you are creating your Vert.x instance, for example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">ClusterManager mgr = new InfinispanClusterManager();

VertxOptions options = new VertxOptions().setClusterManager(mgr);

Vertx.clusteredVertx(options, res -&gt; {
  if (res.succeeded()) {
    Vertx vertx = res.result();
  } else {
    // failed!
  }
});</code></pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_configuring_this_cluster_manager">Configuring this cluster manager</h2>
<div class="sectionbody">
<div class="paragraph">
<p>The default cluster manager configuration can be modified with <code>infinispan.xml</code> and/or <code>jgroups.xml</code> files.
The former configures the data grid, the latter group management and member discovery.</p>
</div>
<div class="paragraph">
<p>You can place one or both of them on your classpath.
If you want to embed your custom file in a fat jar, it must be located at the root of the fat jar.
If it&#8217;s an external file, the <strong>directory</strong> containing the file must be added to the classpath. For
example, if you are using the <em>launcher</em> class from Vert.x, the classpath enhancement can be done as follows:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-shell" data-lang="shell"># If infinispan.xml and/or jgroups.xml files are in the current directory:
java -jar my-app.jar -cp . -cluster

# If infinispan.xml and/or jgroups.xml files are in the conf directory:
java -jar my-app.jar -cp conf -cluster</code></pre>
</div>
</div>
<div class="paragraph">
<p>Another way to override the configuration is by providing the file locations via system properties:
<code>vertx.infinispan.config</code> and/or <code>vertx.jgroups.config</code>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-shell" data-lang="shell"># Use a cluster configuration located in an external file
java -Dvertx.infinispan.config=./config/my-infinispan.xml -jar ... -cluster

# Or use a custom configuration from the classpath
java -Dvertx.infinispan.config=my/package/config/my-infinispan.xml -jar ... -cluster</code></pre>
</div>
</div>
<div class="paragraph">
<p>The cluster manager will search for the file in classpath first, and fallback to the filesystem.</p>
</div>
<div class="paragraph">
<p>The system properties, when present, override any <code>infinispan.xml</code> or <code>jgroups.xml</code> on the classpath.</p>
</div>
<div class="paragraph">
<p>The xml files are Infinispan and JGroups configuration files and are described in detail in the documentation on the Infinispan and JGroups web-sites.</p>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<div class="title">Important</div>
</td>
<td class="content">
if a <code>jgroups.xml</code> file is on the classpath or if you set the <code>vertx.jgroups.config</code> system property,
it will override any JGroups <code>stack-file</code> path defined in the Infinispan configuration file.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The default JGroups configuration uses multicast for discovery and TCP for group management.
Make sure multicast is enabled on your network for this to work.</p>
</div>
<div class="paragraph">
<p>For full documentation on how to configure the transport differently or use a different transport please consult the
Infinispan / JGroups documentations.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_using_an_existing_infinispan_cache_manager">Using an existing Infinispan Cache Manager</h2>
<div class="sectionbody">
<div class="paragraph">
<p>You can pass an existing <code>DefaultCacheManager</code> in the cluster manager to reuse an existing cache manager:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">ClusterManager mgr = new InfinispanClusterManager(cacheManager);

VertxOptions options = new VertxOptions().setClusterManager(mgr);

Vertx.clusteredVertx(options, res -&gt; {
  if (res.succeeded()) {
    Vertx vertx = res.result();
  } else {
    // failed!
  }
});</code></pre>
</div>
</div>
<div class="paragraph">
<p>In this case, vert.x is not the cache manager owner and so do not shut it down on close.</p>
</div>
<div class="paragraph">
<p>Notice that the custom Infinispan instance need to be configured with:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-xml" data-lang="xml">&lt;cache-container default-cache="distributed-cache"&gt;
 &lt;distributed-cache name="distributed-cache"/&gt;
 &lt;distributed-cache name="__vertx.subs"/&gt;
 &lt;replicated-cache name="__vertx.haInfo"/&gt;
 &lt;distributed-cache-configuration name="__vertx.distributed.cache.configuration"/&gt;
&lt;/cache-container&gt;</code></pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_configuring_for_kubernetes">Configuring for Kubernetes</h2>
<div class="sectionbody">
<div class="paragraph">
<p>On Kubernetes, JGroups should be configured to use the <code>KUBE_PING</code> protocol.</p>
</div>
<div class="paragraph">
<p>First, add the <code>org.infinispan:infinispan-cloud:${infinispan.version}</code> and <code>org.jgroups.kubernetes:jgroups-kubernetes:${jgroups.kubernetes.version}</code> dependencies to your project.
With Maven it looks like:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-xml" data-lang="xml">&lt;dependency&gt;
 &lt;groupId&gt;org.infinispan&lt;/groupId&gt;
 &lt;artifactId&gt;infinispan-cloud&lt;/artifactId&gt;
 &lt;version&gt;${infinispan.version}&lt;/version&gt;
&lt;/dependency&gt;
&lt;dependency&gt;
 &lt;groupId&gt;org.jgroups.kubernetes&lt;/groupId&gt;
 &lt;artifactId&gt;jgroups-kubernetes&lt;/artifactId&gt;
 &lt;version&gt;${jgroups.kubernetes.version}&lt;/version&gt;
&lt;/dependency&gt;
&lt;dependency&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>Then, set the <code>vertx.jgroups.config</code> system property to <code>default-configs/default-jgroups-kubernetes.xml</code>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-shell" data-lang="shell">-Dvertx.jgroups.config=default-configs/default-jgroups-kubernetes.xml</code></pre>
</div>
</div>
<div class="paragraph">
<p>This JGroups stack file is located in the <code>infinispan-cloud</code> JAR and preconfigured for Kubernetes.</p>
</div>
<div class="paragraph">
<p>Also, set the project namespace as the scope for discovery.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-Dockerfile" data-lang="Dockerfile">ENV KUBERNETES_NAMESPACE my-project</code></pre>
</div>
</div>
<div class="paragraph">
<p>Optionnaly, to create separate clusters in the same namespace, add a labels selector:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-Dockerfile" data-lang="Dockerfile">ENV KUBERNETES_LABELS my-label=my-value</code></pre>
</div>
</div>
<div class="paragraph">
<p>Then, force usage of IPv4 in the JVM with a system property.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-shell" data-lang="shell">-Djava.net.preferIPv4Stack=true</code></pre>
</div>
</div>
<div class="paragraph">
<p>Eventually, the setup needs a service account.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-shell" data-lang="shell">oc policy add-role-to-user view system:serviceaccount:$(oc project -q):default -n $(oc project -q)</code></pre>
</div>
</div>
<div class="paragraph">
<p>Further configuration details are available on the <a href="https://github.com/jgroups-extras/jgroups-kubernetes">Kubernetes discovery protocol for JGroups repository</a>.</p>
</div>
<div class="sect2">
<h3 id="_rolling_updates">Rolling updates</h3>
<div class="paragraph">
<p>During rolling udpates, the Infinispan team <a href="http://infinispan.org/docs/stable/user_guide/user_guide.html#using_kubernetes_and_openshift_rolling_updates">recommends</a> to replace pods one by one.</p>
</div>
<div class="paragraph">
<p>To do so, we must configure Kubernetes to:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>never start more than one new pod at once</p>
</li>
<li>
<p>forbid more than one unavailable pod during the process</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-yaml" data-lang="yaml">spec:
 strategy:
   type: Rolling
   rollingParams:
     updatePeriodSeconds: 10
     intervalSeconds: 20
     timeoutSeconds: 600
     maxUnavailable: 1 <b class="conum">(1)</b>
     maxSurge: 1 <b class="conum">(2)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>the maximum number of pods that can be unavailable during the update process</p>
</li>
<li>
<p>the maximum number of pods that can be created over the desired number of pods</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>Also, pod readiness probe must take cluster health into account.
Indeed, when a node joins or leaves the cluster, Infinispan rebalances the data across members, and it is better to avoid concurrent state transfers.
When the state transfer completes, the cluster health goes back to <code>HEALTHY</code>.</p>
</div>
<div class="paragraph">
<p>The readiness probe can be implemented with <a href="../../vertx-health-check/java/">Vert.x Health Checks</a>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">Handler&lt;Future&lt;Status&gt;&gt; procedure = ClusterHealthCheck.createProcedure(vertx, true);
HealthChecks checks = HealthChecks.create(vertx).register("cluster-health", procedure);</code></pre>
</div>
</div>
<div class="paragraph">
<p>After creation, it can be exposed over HTTP with a <a href="../../vertx-web/java/">Vert.x Web</a> router handler:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">Router router = Router.router(vertx);
router.get("/readiness").handler(HealthCheckHandler.createWithHealthChecks(checks));</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_configuring_for_docker_compose">Configuring for Docker Compose</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Make sure to start the Java Virtual Machines with those system properties:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-shell" data-lang="shell">-Djava.net.preferIPv4Stack=true -Djgroups.tcp.address=NON_LOOPBACK</code></pre>
</div>
</div>
<div class="paragraph">
<p>This will make JGroups pick the interface of the virtual private network created by Docker.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_trouble_shooting_clustering">Trouble shooting clustering</h2>
<div class="sectionbody">
<div class="paragraph">
<p>If the default multicast discovery configuration is not working here are some common causes:</p>
</div>
<div class="sect2">
<h3 id="_multicast_not_enabled_on_the_machine">Multicast not enabled on the machine.</h3>
<div class="paragraph">
<p>It is quite common in particular on OSX machines for multicast to be disabled by default. Please google for
information on how to enable this.</p>
</div>
</div>
<div class="sect2">
<h3 id="_using_wrong_network_interface">Using wrong network interface</h3>
<div class="paragraph">
<p>If you have more than one network interface on your machine (and this can also be the case if you are running
VPN software on your machine), then JGroups may be using the wrong one.</p>
</div>
<div class="paragraph">
<p>To tell JGroups to use a specific interface you can provide the IP address of the interface in the <code>bind_addr</code>
element of the configuration. For example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-xml" data-lang="xml">&lt;TCP bind_addr="192.168.1.20"
    ...
    /&gt;
&lt;MPING bind_addr="192.168.1.20"
    ...
    /&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>Alternatively, if you want to stick with the bundled <code>jgroups.xml</code> file, you can set the <code>jgroups.tcp.address</code> system property:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>-Djgroups.tcp.address=192.168.1.20</pre>
</div>
</div>
<div class="paragraph">
<p>When running Vert.x is in clustered mode, you should also make sure that Vert.x knows about the correct interface.
When running at the command line this is done by specifying the <code>cluster-host</code> option:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>vertx run myverticle.js -cluster -cluster-host your-ip-address</pre>
</div>
</div>
<div class="paragraph">
<p>Where <code>your-ip-address</code> is the same IP address you specified in the JGroups configuration.</p>
</div>
<div class="paragraph">
<p>If using Vert.x programmatically you can specify this using
<code><a href="../../apidocs/io/vertx/core/VertxOptions.html#setClusterHost-java.lang.String-">setClusterHost</a></code>.</p>
</div>
</div>
<div class="sect2">
<h3 id="_using_a_vpn">Using a VPN</h3>
<div class="paragraph">
<p>This is a variation of the above case. VPN software often works by creating a virtual network interface which often
doesn&#8217;t support multicast. If you have a VPN running and you do not specify the correct interface to use in both the
JGroups configuration and to Vert.x then the VPN interface may be chosen instead of the correct interface.</p>
</div>
<div class="paragraph">
<p>So, if you have a VPN running you may have to configure both JGroups and Vert.x to use the correct interface as
described in the previous section.</p>
</div>
</div>
<div class="sect2">
<h3 id="_when_multicast_is_not_available">When multicast is not available</h3>
<div class="paragraph">
<p>In some cases you may not be able to use multicast discovery as it might not be available in your environment. In that case
you should configure another protocol, e.g. <code>TCPPING</code> to use TCP sockets, or <code>S3_PING</code> when running on Amazon EC2.</p>
</div>
<div class="paragraph">
<p>For more information on available JGroups discovery protocols and how to configure them
please consult the <a href="http://www.jgroups.org/manual/index.html#Discovery">JGroups documentation</a>.</p>
</div>
</div>
<div class="sect2">
<h3 id="_problems_with_ipv6">Problems with IPv6</h3>
<div class="paragraph">
<p>If you have troubles configuring an IPv6 host, force the use of IPv4 with the <code>java.net.preferIPv4Stack</code> system property.</p>
</div>
<div class="listingblock">
<div class="content">
<pre>-Djava.net.preferIPv4Stack=true</pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_enabling_logging">Enabling logging</h3>
<div class="paragraph">
<p>When trouble-shooting clustering issues with it&#8217;s often useful to get some logging output from Infinispan and JGroups
to see if it&#8217;s forming a cluster properly. You can do this (when using the default JUL logging) by adding a file
called <code>vertx-default-jul-logging.properties</code> on your classpath. This is a standard java.util.logging (JUL)
configuration file. Inside it set:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>org.infinispan.level=INFO
org.jgroups.level=INFO</pre>
</div>
</div>
<div class="paragraph">
<p>and also</p>
</div>
<div class="listingblock">
<div class="content">
<pre>java.util.logging.ConsoleHandler.level=INFO
java.util.logging.FileHandler.level=INFO</pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_infinispan_logging">Infinispan logging</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Infinispan relies on JBoss logging. JBoss Logging is a logging bridge providing integration with numerous logging frameworks.</p>
</div>
<div class="paragraph">
<p>Add the logging JARs of you choice to the classpath and JBoss Logging will pick them up automatically.</p>
</div>
<div class="paragraph">
<p>If you have multiple logging backends on your classpath, you can force selection with the <code>org.jboss.logging.provider</code> system property.
For exeample:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>-Dorg.jboss.logging.provider=log4j2</pre>
</div>
</div>
<div class="paragraph">
<p>See this <a href="http://docs.jboss.org/hibernate/orm/4.3/topical/html/logging/Logging.html">JBoss Logging guide</a> for more details.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_jgroups_logging">JGroups logging</h2>
<div class="sectionbody">
<div class="paragraph">
<p>JGroups uses JDK logging by default. log4j and log4j2 are supported if the corresponding JARs are found on the classpath.</p>
</div>
<div class="paragraph">
<p>Please refer to the <a href="http://www.jgroups.org/manual/index.html#Logging">JGroups logging documentation</a> if you need
more details or want to implement your own logging backend implementation.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_shareddata_extensions">SharedData extensions</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_asyncmap_content_streams">AsyncMap content streams</h3>
<div class="paragraph">
<p>The <code>InfinispanAsyncMap</code> API allows to retrieve keys, values and entries as streams.
This can be useful if you need to go through the content of a large map for bulk processing.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">InfinispanAsyncMap&lt;K, V&gt; infinispanAsyncMap = InfinispanAsyncMap.unwrap(asyncMap);
ReadStream&lt;K&gt; keyStream = infinispanAsyncMap.keyStream();
ReadStream&lt;V&gt; valueStream = infinispanAsyncMap.valueStream();
ReadStream&lt;Map.Entry&lt;K, V&gt;&gt; entryReadStream = infinispanAsyncMap.entryStream();</code></pre>
</div>
</div>
</div>
</div>
</div>

        

        
          <div id="footer">
            <div id="footer-text">
              
                上次更新时间 2018-09-04 18:06:09 CST
              
              
            </div>
          </div>
        
      </div>
    </div>
  </div>
</div>

<footer>
  <div class="container">
    <div class="row">
      <div class="col-xs-4 col-sm-4 col-md-2 col-lg-2">
        <h2>Eclipse Vert.x</h2>
        <ul class="list-unstyled">
          <li><a href="https://vertx.tk/">Home</a></li>
          <li><a href="https://vertx.tk/download/">Download</a></li>
          <li><a href="https://vertx.tk/docs/">Documentation</a></li>
          <li><a href="https://github.com/vert-x3/wiki/wiki">Wiki</a></li>
          <li><a href="https://vertx.tk/blog/">Blog</a></li>
          <li><a href="https://vertx.tk/vertx2/" class="vertx-2-link">Vert.x 2</a></li>
        </ul>
      </div>
      <div class="col-xs-4 col-sm-4 col-md-2 col-lg-2">
        <h2>Community</h2>
        <ul class="list-unstyled">
          <li><a href="https://vertx.tk/community/">Help &amp; Contributors</a></li>
          <li><a href="https://vertx.tk/materials/">Learning materials</a></li>
          <li><a href="https://groups.google.com/forum/?fromgroups#!forum/vertx">User Group</a></li>
          <li><a href="https://groups.google.com/forum/?fromgroups#!forum/vertx-dev">Developer Group</a></li>
        </ul>
      </div>
      <div class="col-xs-4 col-sm-4 col-md-2 col-lg-2">
        <h2>Eclipse</h2>
        <ul class="list-unstyled">
          <li><a href="http://www.eclipse.org/">Eclipse Foundation</a></li>
          <li><a href="https://eclipse.org/legal/privacy.php">Privacy Policy</a></li>
          <li><a href="https://eclipse.org/legal/termsofuse.php">Terms of Use</a></li>
          <li><a href="https://eclipse.org/legal/copyright.php">Copyright Agent</a></li>
          <li><a href="http://www.eclipse.org/legal">Legal Resources</a></li>
        </ul>
      </div>

      <div class="col-xs-12 col-sm-12 col-md-6 col-lg-6 copyright">
        <p>Eclipse Vert.x is open source and dual-licensed under the <a href="http://www.eclipse.org/legal/epl-v20.html">Eclipse Public License 2.0</a> and <a href="https://www.apache.org/licenses/LICENSE-2.0.html">Apache License 2.0</a>.</p>
        <p>This website is licensed under the <a href="http://creativecommons.org/licenses/by-sa/3.0/">CC BY-SA 3.0 License</a>.<br>
        Design by <a href="https://www.michel-kraemer.com">Michel Kr&auml;mer</a>.</p>
        <div class="row">
          <div class="col-sm-12 col-md-5 col-md-offset-1 col-lg-offset-2">
            <a href="http://eclipse.org">
            <img class="logo eclipse-logo" src="https://vertx.tk/assets/eclipse_logo_grey_small.png" width="204" height="48">
            </a>
          </div>
          <div class="col-sm-12 col-md-5 col-md-offset-1 col-lg-offset-0">
            <a href="http://cloudbees.com">
            <img class="logo cloudbees-logo" src="https://vertx.tk/assets/Button-Built-on-CB-1-grey.png" width="180" height="48">
           </a>
          </div>
          <div class="col-sm-12 col-md-5 col-md-offset-7 jprofiler">
            <a href="http://www.ej-technologies.com/products/jprofiler/overview.html"
            style="text-decoration:none">
            <img class="logo jprofiler-logo" src="https://vertx.tk/assets/jprofiler-logo.png" width="48" height="48"><span class="jprofiler-logo">&nbsp; JPROFILER</span>
            </a>
          </div>
        </div>
      </div>
    </div>
  </div>
</footer>

<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
<script src="https://vertx.tk/javascripts/bootstrap.min.js"></script>
<script src="https://vertx.tk/javascripts/highlight.pack.js"></script>
<script>hljs.initHighlightingOnLoad();</script>



<script src="https://vertx.tk/javascripts/sidebar.js"></script>


<link rel="stylesheet" type="text/css" href="//cdnjs.cloudflare.com/ajax/libs/cookieconsent2/3.0.3/cookieconsent.min.css" />
<script src="//cdnjs.cloudflare.com/ajax/libs/cookieconsent2/3.0.3/cookieconsent.min.js"></script>
<script>
window.addEventListener("load", function(){
window.cookieconsent.initialise({
  "palette": {
    "popup": {
      "background": "#64386b",
      "text": "#ffcdfd"
    },
    "button": {
      "background": "transparent",
      "text": "#f8a8ff",
      "border": "#f8a8ff"
    }
  },
  "content": {
    "message": "This website uses anonymous cookies to ensure we provide you the best experience. ",
    "link": "Opt out!",
    "href": "https://tools.google.com/dlpage/gaoptout/"
  }
})});
</script>
</body>
</html>

