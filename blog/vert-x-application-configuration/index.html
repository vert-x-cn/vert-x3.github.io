<!DOCTYPE html><html lang=en><head><title>Vert.x Application Configuration</title><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta content="width=device-width,initial-scale=1" name=viewport><meta content="Eclipse Vert.x is a tool-kit for building reactive applications on the JVM." name=description><link href=https://vertx.tk/stylesheets/main.css media=screen rel=stylesheet><link href=https://vertx.tk/stylesheets/font-awesome.min.css media=screen rel=stylesheet><link href=https://vertx.tk/javascripts/styles/rainbow.min.css media=screen rel=stylesheet><!--[if lt IE 9]><script src="http://static.jboss.org/theme/js/libs/html5/pre3.6/html5.min.js"></script><![endif]--><link rel=apple-touch-icon sizes=57x57 href=https://vertx.tk/assets/favicons/vertx-favicon-7/apple-touch-icon-57x57.png><link rel=apple-touch-icon sizes=60x60 href=https://vertx.tk/assets/favicons/vertx-favicon-7/apple-touch-icon-60x60.png><link rel=apple-touch-icon sizes=72x72 href=https://vertx.tk/assets/favicons/vertx-favicon-7/apple-touch-icon-72x72.png><link rel=apple-touch-icon sizes=76x76 href=https://vertx.tk/assets/favicons/vertx-favicon-7/apple-touch-icon-76x76.png><link rel=apple-touch-icon sizes=114x114 href=https://vertx.tk/assets/favicons/vertx-favicon-7/apple-touch-icon-114x114.png><link rel=apple-touch-icon sizes=120x120 href=https://vertx.tk/assets/favicons/vertx-favicon-7/apple-touch-icon-120x120.png><link rel=apple-touch-icon sizes=144x144 href=https://vertx.tk/assets/favicons/vertx-favicon-7/apple-touch-icon-144x144.png><link rel=apple-touch-icon sizes=152x152 href=https://vertx.tk/assets/favicons/vertx-favicon-7/apple-touch-icon-152x152.png><link rel=apple-touch-icon sizes=180x180 href=https://vertx.tk/assets/favicons/vertx-favicon-7/apple-touch-icon-180x180.png><link rel=icon type=image/png href=https://vertx.tk/assets/favicons/vertx-favicon-7/favicon-32x32.png sizes=32x32><link rel=icon type=image/png href=https://vertx.tk/assets/favicons/vertx-favicon-7/android-chrome-192x192.png sizes=192x192><link rel=icon type=image/png href=https://vertx.tk/assets/favicons/vertx-favicon-7/favicon-96x96.png sizes=96x96><link rel=icon type=image/png href=https://vertx.tk/assets/favicons/vertx-favicon-7/favicon-16x16.png sizes=16x16><link rel=manifest href=https://vertx.tk/assets/favicons/vertx-favicon-7/manifest.json><link rel=mask-icon href=https://vertx.tk/assets/favicons/vertx-favicon-7/safari-pinned-tab.svg color=#5bbad5><meta name=msapplication-TileColor content=#7d3194><meta name=msapplication-TileImage content=https://vertx.tk/assets/favicons/vertx-favicon-7/mstile-144x144.png><meta name=theme-color content=#ffffff><link href="https://fonts.googleapis.com/css?family=Ubuntu:400,500,700,400italic" rel=stylesheet type=text/css><link rel=alternate type=application/rss+xml title=RSS href=https://vertx.tk/feed.xml><script>(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
      (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
      m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
    ga('create', 'UA-30144458-1', 'auto');
    ga('create', 'UA-71153120-1', 'auto', 'tracker');
    ga('send', 'pageview');
    ga('tracker.send', 'pageview');</script><style>.page-link-to-github {
      position: relative;
      z-index: 1;
      display: inline-block;
      border: 1px solid #782B90;
      border-radius: 5px;
      color: #782B90;
      font-size: 12px;
      padding: 4px 10px;
      text-decoration: none;
      background-color: #ffffff;
    }
    .page-link-to-github:hover {
      color: #ffffff;
      border-color: #ffffff;
      background-color: #782B90;
    }

    .page-link-to-github .github-icon {
      position: absolute;
      display: inline-block;
      width: 20px;
      height: 20px;
      /*background-position: -50px 0*/
      background: url('https://vertx.tk/assets/github.png') no-repeat 0 0;
    }

    @media (-webkit-min-device-pixel-ratio: 2),(min-resolution:192dpi) {
      .page-link-to-github .github-icon {
        background-image:url('https://vertx.tk/assets/github@2x.png');
        background-size: 150px auto
      }
    }

    .page-link-to-github:hover .github-icon {
      /*background-position: 0 0*/
      background-position: -100px 0
    }
    .text {
      text-decoration: underline
    }
    .page-link-to-github .text {
      padding-left: 27px
    }
    .text {
      padding-right: 8px
    }
    .page-link-to-github {
      float: right;
      top: 4px
    }</style></head><body><a href="http://www.reactivemanifesto.org/" id=reactive-manifesto-banner><img style="border: 0; position: fixed; right: 0; top:0; z-index: 9000" src=https://d379ifj7s9wntv.cloudfront.net/reactivemanifesto/images/ribbons/we-are-reactive-black-right.png></a> <a id=skippy class="sr-only sr-only-focusable" href=#content><div class=container><span class=skiplink-text>Skip to main content</span></div></a><header class="navbar navbar-default navbar-static-top" id=top role=banner><div class=container><div class=navbar-header><button class="navbar-toggle collapsed" type=button data-toggle=collapse data-target=#vertx-navbar-collapse><span class=sr-only>Toggle navigation</span> <span class=icon-bar></span> <span class=icon-bar></span> <span class=icon-bar></span></button> <a href="https://vertx.tk/" class=navbar-brand><img alt=Brand src=https://vertx.tk/assets/logo-sm.png></a></div><nav class="collapse navbar-collapse" id=vertx-navbar-collapse><ul class="nav navbar-nav navbar-right"><li><a href=http://start.vertx.io>Starter</a></li><li><a href="https://vertx.tk/download/">下载</a></li><li><a href="https://vertx.tk/docs/">文档</a></li><li><a href=https://github.com/vert-x3/wiki/wiki>维基</a></li><li><a href="https://vertx.tk/community/">社区</a></li><li><a href="https://vertx.tk/materials/">资料</a></li><li><a href="https://vertx.tk/blog/">博客</a></li></ul></nav></div></header><div class=container><div class="row blog"><article class="col-xs-12 blog-post"><h2 class=blog-post-title>Vert.x Application Configuration</h2><p class=blog-post-meta>20th July 2015 by <a href=http://github.com/cescoffier>cescoffier</a></p><article><h2 id=previously-in-introduction-to-vert-x->Previously in ‘Introduction to Vert.x’</h2><p>In <a href="https://vertx.tk/blog/my-first-vert-x-3-application/">this post</a>, we developed a very simple Vert.x 3 application, and saw how this application can be tested, packaged and executed. That was nice, isn’t it ? Well, ok, that was only the beginning. In this post, we are going to enhance our application to support <em>external</em> configuration.</p><p>So just to remind you, we have an application starting a HTTP server on the port 8080 and replying a polite “Hello” message to all HTTP requests. The previous code is available <a href=https://github.com/cescoffier/my-vertx-first-app/tree/post-1>here</a>. The code developed in this post is in the <a href=https://github.com/cescoffier/my-vertx-first-app/tree/post-2>post-2 branch</a>.</p><h2 id=so-why-do-we-need-configuration->So, why do we need configuration?</h2><p>That’s a good question. The application works right now, but well, let’s say you want to deploy it on a machine where the port 8080 is already taken. We would need to change the port in the application code and in the test, just for this machine. That would be sad. Fortunately, Vert.x applications are configurable.</p><p>Vert.x configurations are using the JSON format, so don’t expect anything complicated. They can be passed to verticle either from the command line, or using an API. Let’s have a look.</p><h2 id=no-8080-anymore>No ‘8080’ anymore</h2><p>The first step is to modify the <code>io.vertx.blog.first.MyFirstVerticle</code> class to not bind to the port 8080, but to read it from the configuration:</p><pre><code class="hljs java"><span class=hljs-function><span class=hljs-keyword>public</span> <span class=hljs-keyword>void</span> <span class=hljs-title>start</span><span class=hljs-params>(Future&lt;Void&gt; fut)</span> </span>{
  vertx
      .createHttpServer()
      .requestHandler(r -&gt; {
        r.response().end(<span class=hljs-string>"&lt;h1&gt;Hello from my first "</span> +
            <span class=hljs-string>"Vert.x 3 application&lt;/h1&gt;"</span>);
      })
      .listen(
          <span class=hljs-comment>// Retrieve the port from the configuration,</span>
          <span class=hljs-comment>// default to 8080.</span>
          config().getInteger(<span class=hljs-string>"http.port"</span>, <span class=hljs-number>8080</span>),
          result -&gt; {
            <span class=hljs-keyword>if</span> (result.succeeded()) {
              fut.complete();
            } <span class=hljs-keyword>else</span> {
              fut.fail(result.cause());
            }
          }
      );
}</code></pre><p>So, the only difference with the previous version is <code>config().getInteger(&quot;http.port&quot;, 8080)</code>. Here, our code is now requesting the configuration and check whether the <em>http.port</em> property is set. If not, the port 8080 is used as fall-back. The retrieved configuration is a <code>JsonObject</code>.</p><p>As we are using the port 8080 by default, you can still package our application and run it as before:</p><pre><code class="hljs bash">mvn clean package
java -jar target/my-first-app-<span class=hljs-number>1.0</span>-SNAPSHOT-fat.jar</code></pre><p>Simple right ?</p><h2 id=api-based-configuration-random-port-for-the-tests>API-based configuration - Random port for the tests</h2><p>Now that the application is configurable, let’s try to provide a configuration. In our test, we are going to configure our application to use the port 8081. So, previously we were deploying our verticle with:</p><pre><code class="hljs java">vertx.deployVerticle(MyFirstVerticle.class.getName(), context.asyncAssertSuccess());</code></pre><p>Let’s now pass some <em>deployment options</em>:</p><pre><code class="hljs java">port = <span class=hljs-number>8081</span>;
DeploymentOptions options = <span class=hljs-keyword>new</span> DeploymentOptions()
    .setConfig(<span class=hljs-keyword>new</span> JsonObject().put(<span class=hljs-string>"http.port"</span>, port)
);
vertx.deployVerticle(MyFirstVerticle.class.getName(), options, context.asyncAssertSuccess());</code></pre><p>The <code>DeploymentOptions</code> object lets us customize various parameters. In particular, it lets us inject the <code>JsonObject</code> retrieved by the verticle when using the <code>config()</code> method.</p><p>Obviously, the test connecting to the server needs to be slightly modified to use the right port (<code>port</code> is a field):</p><pre><code class="hljs java">vertx.createHttpClient().getNow(port, <span class=hljs-string>"localhost"</span>, <span class=hljs-string>"/"</span>, response -&gt; {
  response.handler(body -&gt; {
    context.assertTrue(body.toString().contains(<span class=hljs-string>"Hello"</span>));
    async.complete();
  });
});</code></pre><p>Ok, well, this does not really fix our issue. What happens when the port 8081 is used too. Let’s now pick a random port:</p><pre><code class="hljs java">ServerSocket socket = <span class=hljs-keyword>new</span> ServerSocket(<span class=hljs-number>0</span>);
port = socket.getLocalPort();
socket.close();

DeploymentOptions options = <span class=hljs-keyword>new</span> DeploymentOptions()
    .setConfig(<span class=hljs-keyword>new</span> JsonObject().put(<span class=hljs-string>"http.port"</span>, port)
    );

vertx.deployVerticle(MyFirstVerticle.class.getName(), options, context.asyncAssertSuccess());</code></pre><p>So, the idea is very simple. We open a <em>server socket</em> that would pick a random port (that’s why we put 0 as parameter). We retrieve the used port and close the socket. Be aware that this method is <strong>not</strong> perfect and may fail if the picked port becomes used between the <code>close</code> method and the start of our HTTP server. However, it would work fine in the very high majority of the case.</p><p>With this in place, our test is now using a random port. Execute them with:</p><pre><code class="hljs bash">mvn clean test</code></pre><h2 id=external-configuration-let-s-run-on-another-port>External configuration - Let’s run on another port</h2><p>Ok, well random port is not what we want in <em>production</em>. Could you imagine the face of your production team if you tell them that your application is picking a random port. It can actually be funny, but we should never mess with the production team.</p><p>So for the actual execution of your application, let’s pass the configuration in an external file. The configuration is stored in a <em>json</em> file.</p><p>Create the <code>src/main/conf/my-application-conf.json</code> with the following content:</p><pre><code class="hljs javascript">{
  <span class=hljs-string>"http.port"</span> : <span class=hljs-number>8082</span>
}</code></pre><p>And now, to use this configuration just launch your application with:</p><pre><code class="hljs bash">java -jar target/my-first-app-<span class=hljs-number>1.0</span>-SNAPSHOT-fat.jar -conf src/main/conf/my-application-conf.json</code></pre><p>Open a browser on <a href=http://localhost:8082>http://localhost:8082</a>, here it is !</p><p>How does that work ? Remember, our <em>fat jar</em> is using the <code>Starter</code> class (provided by Vert.x) to launch our application. This class is reading the <code>-conf</code> parameter and create the corresponding deployment options when deploying our verticle.</p><h2 id=conclusion>Conclusion</h2><p>After having developed your first Vert.x application, we have seen how this application is configurable, and this without adding any complexity to our application. <a href="/blog/some-rest-with-vert-x/">In the next post</a>, we are going to see how we can use vertx-web to develop a small application serving static pages and a REST API. A bit more fancy, but still very simple.</p><p>Happy Coding and &amp; Stay Tuned!</p></article></article></div><div class=row><div class=col-xs-12 id=disqus_thread></div></div><script>var disqus_config = function () {
  this.page.url = "https://vertx.tk/blog/vert-x-application-configuration/";
  this.page.identifier = "/blog/vert-x-application-configuration/";
  };
  (function() { // DON'T EDIT BELOW THIS LINE
  var d = document, s = d.createElement('script');
  s.src = 'https://vertx.disqus.com/embed.js';
  s.setAttribute('data-timestamp', +new Date());
  (d.head || d.body).appendChild(s);
  })();</script><noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript></div><footer><div class=container><div class=row><div class="col-xs-4 col-sm-4 col-md-2 col-lg-2"><h2>Eclipse Vert.x</h2><ul class=list-unstyled><li><a href="https://vertx.tk/">主页</a></li><li><a href="https://vertx.tk/download/">下载</a></li><li><a href="https://vertx.tk/docs/">文档</a></li><li><a href=https://github.com/vert-x3/wiki/wiki>维基</a></li><li><a href="https://vertx.tk/blog/">博客</a></li></ul></div><div class="col-xs-4 col-sm-4 col-md-2 col-lg-2"><h2>Community</h2><ul class=list-unstyled><li><a href="https://vertx.tk/community/">Help &amp; Contributors</a></li><li><a href="https://vertx.tk/materials/">Learning materials</a></li><li><a href=https://groups.google.com/forum/?fromgroups#!forum/vertx>User Group</a></li><li><a href=https://groups.google.com/forum/?fromgroups#!forum/vertx-dev>Developer Group</a></li></ul></div><div class="col-xs-4 col-sm-4 col-md-2 col-lg-2"><h2>Eclipse</h2><ul class=list-unstyled><li><a href="http://www.eclipse.org/">Eclipse Foundation</a></li><li><a href=https://eclipse.org/legal/privacy.php>Privacy Policy</a></li><li><a href=https://eclipse.org/legal/termsofuse.php>Terms of Use</a></li><li><a href=https://eclipse.org/legal/copyright.php>Copyright Agent</a></li><li><a href=http://www.eclipse.org/legal>Legal Resources</a></li></ul></div><div class="col-xs-12 col-sm-12 col-md-6 col-lg-6 copyright"><p>Eclipse Vert.x is open source and dual-licensed under the <a href=http://www.eclipse.org/legal/epl-v20.html>Eclipse Public License 2.0</a> and <a href=https://www.apache.org/licenses/LICENSE-2.0.html>Apache License 2.0</a>.</p><p>This website is licensed under the <a href="http://creativecommons.org/licenses/by-sa/3.0/">CC BY-SA 3.0 License</a>.<br>Design by <a href=https://www.michel-kraemer.com>Michel Kr&auml;mer</a>.</p><div class=row><div class="col-sm-12 col-md-5 col-md-offset-1 col-lg-offset-2"><a href=http://eclipse.org><img class="logo eclipse-logo" src=https://vertx.tk/assets/eclipse_logo_grey_small.png width=204 height=48></a></div><div class="col-sm-12 col-md-5 col-md-offset-1 col-lg-offset-0"><a href=http://cloudbees.com><img class="logo cloudbees-logo" src=https://vertx.tk/assets/Button-Built-on-CB-1-grey.png width=180 height=48></a></div><div class="col-sm-12 col-md-5 col-md-offset-7 jprofiler"><a href=http://www.ej-technologies.com/products/jprofiler/overview.html style=text-decoration:none><img class="logo jprofiler-logo" src=https://vertx.tk/assets/jprofiler-logo.png width=48 height=48><span class=jprofiler-logo>&nbsp; JPROFILER</span></a></div></div></div></div></div></footer><script src=https://cdnjs.cloudflare.com/ajax/libs/jquery/1.9.1/jquery.min.js></script><script src=https://vertx.tk/javascripts/bootstrap.min.js></script><script src=https://vertx.tk/javascripts/highlight.pack.js></script><script>hljs.initHighlightingOnLoad();</script><link rel=stylesheet type=text/css href="//cdnjs.cloudflare.com/ajax/libs/cookieconsent2/3.0.3/cookieconsent.min.css"><script src=//cdnjs.cloudflare.com/ajax/libs/cookieconsent2/3.0.3/cookieconsent.min.js></script><script>window.addEventListener("load", function(){
window.cookieconsent.initialise({
  "palette": {
    "popup": {
      "background": "#64386b",
      "text": "#ffcdfd"
    },
    "button": {
      "background": "transparent",
      "text": "#f8a8ff",
      "border": "#f8a8ff"
    }
  },
  "content": {
    "message": "This website uses anonymous cookies to ensure we provide you the best experience. ",
    "link": "Opt out!",
    "href": "https://tools.google.com/dlpage/gaoptout/"
  }
})});</script></body></html>