<!DOCTYPE html><html lang=en><head><title>Building services and APIs with AMQP 1.0</title><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta content="width=device-width,initial-scale=1" name=viewport><meta content="Eclipse Vert.x is a tool-kit for building reactive applications on the JVM." name=description><link href=https://vertx.tk/stylesheets/main.css media=screen rel=stylesheet><link href=https://vertx.tk/stylesheets/font-awesome.min.css media=screen rel=stylesheet><link href=https://vertx.tk/javascripts/styles/rainbow.min.css media=screen rel=stylesheet><!--[if lt IE 9]><script src="http://static.jboss.org/theme/js/libs/html5/pre3.6/html5.min.js"></script><![endif]--><link rel=apple-touch-icon sizes=57x57 href=https://vertx.tk/assets/favicons/vertx-favicon-7/apple-touch-icon-57x57.png><link rel=apple-touch-icon sizes=60x60 href=https://vertx.tk/assets/favicons/vertx-favicon-7/apple-touch-icon-60x60.png><link rel=apple-touch-icon sizes=72x72 href=https://vertx.tk/assets/favicons/vertx-favicon-7/apple-touch-icon-72x72.png><link rel=apple-touch-icon sizes=76x76 href=https://vertx.tk/assets/favicons/vertx-favicon-7/apple-touch-icon-76x76.png><link rel=apple-touch-icon sizes=114x114 href=https://vertx.tk/assets/favicons/vertx-favicon-7/apple-touch-icon-114x114.png><link rel=apple-touch-icon sizes=120x120 href=https://vertx.tk/assets/favicons/vertx-favicon-7/apple-touch-icon-120x120.png><link rel=apple-touch-icon sizes=144x144 href=https://vertx.tk/assets/favicons/vertx-favicon-7/apple-touch-icon-144x144.png><link rel=apple-touch-icon sizes=152x152 href=https://vertx.tk/assets/favicons/vertx-favicon-7/apple-touch-icon-152x152.png><link rel=apple-touch-icon sizes=180x180 href=https://vertx.tk/assets/favicons/vertx-favicon-7/apple-touch-icon-180x180.png><link rel=icon type=image/png href=https://vertx.tk/assets/favicons/vertx-favicon-7/favicon-32x32.png sizes=32x32><link rel=icon type=image/png href=https://vertx.tk/assets/favicons/vertx-favicon-7/android-chrome-192x192.png sizes=192x192><link rel=icon type=image/png href=https://vertx.tk/assets/favicons/vertx-favicon-7/favicon-96x96.png sizes=96x96><link rel=icon type=image/png href=https://vertx.tk/assets/favicons/vertx-favicon-7/favicon-16x16.png sizes=16x16><link rel=manifest href=https://vertx.tk/assets/favicons/vertx-favicon-7/manifest.json><link rel=mask-icon href=https://vertx.tk/assets/favicons/vertx-favicon-7/safari-pinned-tab.svg color=#5bbad5><meta name=msapplication-TileColor content=#7d3194><meta name=msapplication-TileImage content=https://vertx.tk/assets/favicons/vertx-favicon-7/mstile-144x144.png><meta name=theme-color content=#ffffff><link href="https://fonts.googleapis.com/css?family=Ubuntu:400,500,700,400italic" rel=stylesheet type=text/css><link rel=alternate type=application/rss+xml title=RSS href=https://vertx.tk/feed.xml><script>(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
      (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
      m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
    ga('create', 'UA-30144458-1', 'auto');
    ga('create', 'UA-71153120-1', 'auto', 'tracker');
    ga('send', 'pageview');
    ga('tracker.send', 'pageview');</script><style>.page-link-to-github {
      position: relative;
      z-index: 1;
      display: inline-block;
      border: 1px solid #782B90;
      border-radius: 5px;
      color: #782B90;
      font-size: 12px;
      padding: 4px 10px;
      text-decoration: none;
      background-color: #ffffff;
    }
    .page-link-to-github:hover {
      color: #ffffff;
      border-color: #ffffff;
      background-color: #782B90;
    }

    .page-link-to-github .github-icon {
      position: absolute;
      display: inline-block;
      width: 20px;
      height: 20px;
      /*background-position: -50px 0*/
      background: url('https://vertx.tk/assets/github.png') no-repeat 0 0;
    }

    @media (-webkit-min-device-pixel-ratio: 2),(min-resolution:192dpi) {
      .page-link-to-github .github-icon {
        background-image:url('https://vertx.tk/assets/github@2x.png');
        background-size: 150px auto
      }
    }

    .page-link-to-github:hover .github-icon {
      /*background-position: 0 0*/
      background-position: -100px 0
    }
    .text {
      text-decoration: underline
    }
    .page-link-to-github .text {
      padding-left: 27px
    }
    .text {
      padding-right: 8px
    }
    .page-link-to-github {
      float: right;
      top: 4px
    }</style></head><body><a href="http://www.reactivemanifesto.org/" id=reactive-manifesto-banner><img style="border: 0; position: fixed; right: 0; top:0; z-index: 9000" src=https://d379ifj7s9wntv.cloudfront.net/reactivemanifesto/images/ribbons/we-are-reactive-black-right.png></a> <a id=skippy class="sr-only sr-only-focusable" href=#content><div class=container><span class=skiplink-text>Skip to main content</span></div></a><header class="navbar navbar-default navbar-static-top" id=top role=banner><div class=container><div class=navbar-header><button class="navbar-toggle collapsed" type=button data-toggle=collapse data-target=#vertx-navbar-collapse><span class=sr-only>Toggle navigation</span> <span class=icon-bar></span> <span class=icon-bar></span> <span class=icon-bar></span></button> <a href="https://vertx.tk/" class=navbar-brand><img alt=Brand src=https://vertx.tk/assets/logo-sm.png></a></div><nav class="collapse navbar-collapse" id=vertx-navbar-collapse><ul class="nav navbar-nav navbar-right"><li><a href=http://start.vertx.io>Starter</a></li><li><a href=https://vertx.io>官网</a></li><li><a href="https://vertx.tk/download/">下载</a></li><li><a href="https://vertx.tk/docs/">文档</a></li><li><a href=https://github.com/vert-x3/wiki/wiki>维基</a></li><li><a href="https://vertx.tk/community/">社区</a></li><li><a href="https://vertx.tk/materials/">资料</a></li><li><a href="https://vertx.tk/blog/">博客</a></li></ul></nav></div></header><div class=container><div class="row blog"><article class="col-xs-12 blog-post"><h2 class=blog-post-title>Building services and APIs with AMQP 1.0</h2><p class=blog-post-meta>25th January 2017 by <a href=http://github.com/scholzj>scholzj</a></p><article><p>Microservices and APIs are everywhere. Everyone talks about them, presentation slides are full of them … some people are actually even building them. Microservices and APIs are of course not completely new concepts and they are a bit over-hyped. But in general the ideas behind them are not bad. Unfortunately, many people seem to believe that the only way how to implement an API in microservice is to use HTTP and REST. That is of course not true. Microservices and APIs can be based on many different protocols and technologies. My favorite one is of course <a href=http://www.amqp.org>AMQP</a>. Don’t take me wrong, HTTP and REST is not necessarily bad. But in some cases AMQP is simply better and creating AMQP based APIs does not need to be complicated.</p><p><div class="admonition-block note"><table><tbody><tr><td class=admonition-icon><i class="admonition-icon fa fa-comment"></i></td><td class=content><span class=content>this is a re-publication of the following <a href=http://blog.effectivemessaging.com/2017/01/building-services-and-apis-with-amqp-10.html>blog post</a></span></td></tr></tbody></table></div></p><h2 id=livescore-service>LiveScore service</h2><p>For demonstration, I will use a very simple service for keeping scores of football games. It has very basic API. It has only three calls:</p><ul><li>Add a new game</li><li>Update a score of existing game</li><li>List the scores The AMQP variants will be additionally able to push live updates to the clients.</li></ul><p>The demo is using Java and Vert.x toolkit. <a href="http://vertx.io/">Vert.x</a> is cool and I definitely recommend it to everyone. But most of the stuff from the demo should be possible also in any other programming languages and/or framework.</p><h2 id=http-api>HTTP API</h2><p>HTTP implementation of my service is a typical REST API. Since it is very simple, it accepts requests only on one endpoint – /api/v1.0/scores. New games are added as POST operations, scores are updated with PUT operations and list of all scores can be obtained with GET.</p><p>With Vert.x, creating HTTP/REST API is very easy. First the web router has to be created with all planned API calls:</p><pre><code class="hljs java">router = Router.router(vertx);  
router.route(<span class=hljs-string>"/api/v1.0/*"</span>).handler(BodyHandler.create());  
router.get(<span class=hljs-string>"/api/v1.0/scores"</span>).handler(<span class=hljs-keyword>this</span>::getScores);  
router.post(<span class=hljs-string>"/api/v1.0/scores"</span>).handler(<span class=hljs-keyword>this</span>::addGame);  
router.put(<span class=hljs-string>"/api/v1.0/scores"</span>).handler(<span class=hljs-keyword>this</span>::setScore);</code></pre><p>Then the HTTP server has to be created and linked with the router:</p><pre><code class="hljs java">HttpServerOptions httpOptions = <span class=hljs-keyword>new</span> HttpServerOptions();  
server = vertx.createHttpServer(httpOptions)  
   .requestHandler(router::accept)  
   .listen(httpPort);</code></pre><p>And finally the handlers which will be triggered for each API call have to be implemented as well. The full code is on <a href=https://github.com/scholzj/livescore-demo-vertx-http>GitHub</a>.</p><p><img src=/assets/blog/services-and-apis-with-amqp/HTTP-API.png alt="HTTP based API"></p><p>The HTTP API doesn’t provide any way how to automatically push the score updates to the clients. The clients simply have to poll the service periodically to get the updates. HTTP has of course some ways how to push live updates to clients. For example, with WebSockets or with chunked transfers. However, these are not that easy to implement. The service would also need to keep separate connection with every client and push the updates for each of them separately.</p><h2 id=amqp-api>AMQP API</h2><p>Creating the HTTP API was really easy. Creating an AMQP API has to be more complicated, right? We would need an AMQP server, which will listen on some port, accept the connections, sessions, links and so on. There are usually no nice and simple to use libraries for this.</p><p>Sure, this is one way how to do it. There is actually a nice library called <a href=http://qpid.apache.org/proton/index.html>Apache Qpid Proton</a>. It has Java and C versions and bindings into many other languages (Go, C++, Python, …). It makes creating your own AMQP server lot easier. It will take care of decoding and encoding the AMQP protocol, handling the connections, sessions etc. But still, Qpid Proton is not even nearly as easy to use as the HTTP router used for the HTTP API.</p><p><img src=/assets/blog/services-and-apis-with-amqp/AMQP-Server-API.png alt="API with AMQP server"></p><p>Are there any easier options? What if all what is needed to create AMQP based API is a simple AMQP client? Normally, that should not be a possible because we need the API to listen on some port for the clients to connect to it and send requests. And clients usually don’t listen on any ports. However, Apache Qpid has something called <a href=http://qpid.apache.org/components/dispatch-router/index.html>Dispatch</a>. It works as a lightweight AMQP router. Dispatch will serve as the AMQP server which was missing. It will take care of handling client connections, security and shield the service from the actual clients. All the service needs to do is to use AMQP client to connect to Dispatch on predefined address and wait for the request.</p><p><img src=/assets/blog/services-and-apis-with-amqp/AMQP-API.png alt="AMQP API with Dispatch router"></p><p>Dispatch needs to be configured with three API entry points as addresses:</p><pre><code class=hljs><span class=hljs-tag>address</span> <span class=hljs-rules>{  
    <span class=hljs-rule><span class=hljs-attribute>prefix</span>:<span class=hljs-value> /setScore  
    distribution: balanced  
</span></span></span>}  
<span class=hljs-tag>address</span> <span class=hljs-rules>{  
    <span class=hljs-rule><span class=hljs-attribute>prefix</span>:<span class=hljs-value> /getScore  
    distribution: balanced  
</span></span></span>}  
<span class=hljs-tag>address</span> <span class=hljs-rules>{  
    <span class=hljs-rule><span class=hljs-attribute>prefix</span>:<span class=hljs-value> /addGame  
    distribution: balanced  
</span></span></span>}</code></pre><p>LiveScore service will connect to these addresses as a receiver / consumer. Clients will connect to them as senders /producers. And Dispatch will take care of routing the messages between the clients and the service. Clients can also create additional receivers so that the service is able to respond to their requests and specify the address of the receiver as the reply-to header in the request message. LiveScore service will automatically send the response to this address. But specifying a reply-to is not mandatory. If the client wants, it can simply fire the request and forget about the response.</p><p>LiveScore service is using Vert.x AMQP Bridge which allows easy integration between the Vert.x Event Bus and the AMQP connection to my router. The service starts the AMQP Bridge and if it successfully connects to Dispatch it creates three receivers for the API calls.</p><pre><code class="hljs java">AmqpBridgeOptions options = <span class=hljs-keyword>new</span> AmqpBridgeOptions().addEnabledSaslMechanism(<span class=hljs-string>"ANONYMOUS"</span>);  
bridge = AmqpBridge.create(vertx, options);  
bridge.start(amqpHostname, amqpPort, res -&gt; {  
   <span class=hljs-keyword>if</span> (res.succeeded())  
   {  
     bridge.createConsumer(<span class=hljs-string>"/setScore"</span>).setMaxBufferedMessages(<span class=hljs-number>100</span>).handler(<span class=hljs-keyword>this</span>::setScore);  
     bridge.createConsumer(<span class=hljs-string>"/getScores"</span>).setMaxBufferedMessages(<span class=hljs-number>100</span>).handler(<span class=hljs-keyword>this</span>::getScores);  
     bridge.createConsumer(<span class=hljs-string>"/addGame"</span>).setMaxBufferedMessages(<span class=hljs-number>100</span>).handler(<span class=hljs-keyword>this</span>::addGame);  
     fut.complete();  
   }  
   <span class=hljs-keyword>else</span>  
   {  
     fut.fail(res.cause());  
   }  
});</code></pre><p>The only other thing which needs to be done is creating handlers for handling the requests received from clients:</p><pre><code class="hljs java"><span class=hljs-function><span class=hljs-keyword>public</span> <span class=hljs-keyword>void</span> <span class=hljs-title>getScores</span><span class=hljs-params>(Message&lt;Object&gt; msg)</span>  
</span>{  
   <span class=hljs-keyword>if</span>(msg.replyAddress() != <span class=hljs-keyword>null</span>)  
   {  
     JsonObject response = <span class=hljs-keyword>new</span> JsonObject();  
     response.put(<span class=hljs-string>"application_properties"</span>, <span class=hljs-keyword>new</span> JsonObject().put(<span class=hljs-string>"status"</span>, <span class=hljs-number>200</span>));  
     response.put(<span class=hljs-string>"body"</span>, <span class=hljs-keyword>new</span> JsonArray(Json.encode(scoreService.getScores())).encode());  
     msg.reply(response);  
   }  
   <span class=hljs-keyword>else</span>  
   {  
     LOG.warn(<span class=hljs-string>"Received LiveScore/getScores request without reply to address"</span>);  
   }  
}</code></pre><p>Live broadcasting of score updates is also very easy. New address has to be added into Dispatch configuration. This address will be used in opposite direction. the service connects to it as sender / producer and clients which want to receive the live updates create a receiver against this address. What is important, this address has to be marked as multicast. Thanks to that every single message will be delivered to all connected clients and not just to one of them:</p><pre><code class=hljs><span class=hljs-tag>address</span> <span class=hljs-rules>{  
    <span class=hljs-rule><span class=hljs-attribute>prefix</span>:<span class=hljs-value> /liveScores  
    distribution: multicast  
</span></span></span>}</code></pre><p><img src=/assets/blog/services-and-apis-with-amqp/AMQP-API-multicast.png alt="Multicasting messages"></p><p>Thanks to the multicast distribution, the service doesn’t need to send a separate update to every single client. It sends the message only once and dispatch takes care of the rest.</p><pre><code class="hljs java"><span class=hljs-function><span class=hljs-keyword>public</span> <span class=hljs-keyword>void</span> <span class=hljs-title>broadcastUpdates</span><span class=hljs-params>(Game game)</span>  
</span>{  
   LOG.info(<span class=hljs-string>"Broadcasting game update "</span> + game);  
   JsonObject message = <span class=hljs-keyword>new</span> JsonObject();  
   message.put(<span class=hljs-string>"body"</span>, <span class=hljs-keyword>new</span> JsonObject(Json.encode(game)).encode());  
   producer.send(message);  
}</code></pre><p>Again, the complete source codes of the demo service are available on <a href=https://github.com/scholzj/livescore-demo-vertx-amqp-bridge>GitHub</a>.</p><h2 id=how-to-structure-amqp-apis->How to structure AMQP APIs?</h2><p>Compared to HTTP and REST, AMQP gives its users a lot more freedom when designing the API. It isn’t tied up by the available HTTP methods.</p><p>My LiveScore service is using the API endpoints named according to their function:</p><ul><li>/LiveScore/addGame</li><li>/LiveScore/setScore</li><li>/LiveScore/getScores It also uses HTTP status codes in application properties of the different messages to describe the result of the request and JSON as the message payload with the actual request and response.</li></ul><p>Is that the best way? To be honest, I don’t know. Just for the request encoding there are many different options. AMQP has its own encodings which supports all possible basic as well as more advanced data types and structures. But AMQP can also transfer any opaque data - be it JSON, XML, Google Protocol Buffers or anything else. For simple request, the payload can be completely skipped and application properties can be used instead. And for everyone who really loves HTTP/REST, one can also model the API in REST style as I did in an <a href=https://github.com/scholzj/livescore-demo-vertx-amqp-bridge-rest-style>alternative implementation</a> of my demo service.</p><h2 id=browser>Browser</h2><p>One of the environments where HTTP is so to say “at home” is browser. AMQP will probably never be as “native” protocol for any browser as HTTP is. However AMQP can be used even from browsers. It has WebSocket binding and there are Javascript AMQP libraries - for example rhea. So AMQP can be also used really everywhere.</p><h2 id=decoupling>Decoupling</h2><p>It is important to mention that the Dispatch router doesn’t decouple the client from the service. If decoupling is what is needed, it can be easily achieved by replacing the Dispatch router with some AMQP broker. The broker would decouple the client from the service without any changes in the service or clients.</p><h2 id=conclusion>Conclusion</h2><p>While creating APIs using AMQP can be very easy, it doesn’t mean that AMQP is the best protocol for all APIs. There are definitely APIs where HTTP is more suitable. But in some use cases, AMQP has clear advantages. In my LiveScore example it is especially one to many communication. It is important to keep the mind open and select the best available for given service.</p></article></article></div><div class=row><div class=col-xs-12 id=disqus_thread></div></div><script>var disqus_config = function () {
  this.page.url = "https://vertx.tk/blog/building-services-and-apis-with-amqp-1-0/";
  this.page.identifier = "/blog/building-services-and-apis-with-amqp-1-0/";
  };
  (function() { // DON'T EDIT BELOW THIS LINE
  var d = document, s = d.createElement('script');
  s.src = 'https://vertx.disqus.com/embed.js';
  s.setAttribute('data-timestamp', +new Date());
  (d.head || d.body).appendChild(s);
  })();</script><noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript></div><footer><div class=container><div class=row><div class="col-xs-4 col-sm-4 col-md-2 col-lg-2"><h2>Eclipse Vert.x</h2><ul class=list-unstyled><li><a href="https://vertx.tk/">主页</a></li><li><a href="https://vertx.tk/download/">下载</a></li><li><a href="https://vertx.tk/docs/">文档</a></li><li><a href=https://github.com/vert-x3/wiki/wiki>维基</a></li><li><a href="https://vertx.tk/blog/">博客</a></li></ul></div><div class="col-xs-4 col-sm-4 col-md-2 col-lg-2"><h2>Community</h2><ul class=list-unstyled><li><a href="https://vertx.tk/community/">帮助 &amp; 贡献者</a></li><li><a href="https://vertx.tk/materials/">学习资料</a></li><li><a href=https://groups.google.com/forum/?fromgroups#!forum/vertx>User Group</a></li><li><a href=https://groups.google.com/forum/?fromgroups#!forum/vertx-dev>Developer Group</a></li><li><a href="//shang.qq.com/wpa/qunwpa?idkey=587f58cacb9557e3291b46098e0fe09427b98a1c0f866da23c04c2762bc7e2ad">QQ群</a></li></ul></div><div class="col-xs-4 col-sm-4 col-md-2 col-lg-2"><h2>Eclipse</h2><ul class=list-unstyled><li><a href="http://www.eclipse.org/">Eclipse Foundation</a></li><li><a href=https://eclipse.org/legal/privacy.php>Privacy Policy</a></li><li><a href=https://eclipse.org/legal/termsofuse.php>Terms of Use</a></li><li><a href=https://eclipse.org/legal/copyright.php>Copyright Agent</a></li><li><a href=http://www.eclipse.org/legal>Legal Resources</a></li></ul></div><div class="col-xs-12 col-sm-12 col-md-6 col-lg-6 copyright"><p>Eclipse Vert.x is open source and dual-licensed under the <a href=http://www.eclipse.org/legal/epl-v20.html>Eclipse Public License 2.0</a> and <a href=https://www.apache.org/licenses/LICENSE-2.0.html>Apache License 2.0</a>.</p><p>This website is licensed under the <a href="http://creativecommons.org/licenses/by-sa/3.0/">CC BY-SA 3.0 License</a>.<br>Design by <a href=https://www.michel-kraemer.com>Michel Kr&auml;mer</a>.</p><div class=row><div class="col-sm-12 col-md-5 col-md-offset-1 col-lg-offset-2"><a href=http://eclipse.org><img class="logo eclipse-logo" src=https://vertx.tk/assets/eclipse_logo_grey_small.png width=204 height=48></a></div><div class="col-sm-12 col-md-5 col-md-offset-1 col-lg-offset-0"><a href=http://cloudbees.com><img class="logo cloudbees-logo" src=https://vertx.tk/assets/Button-Built-on-CB-1-grey.png width=180 height=48></a></div><div class="col-sm-12 col-md-5 col-md-offset-7 jprofiler"><a href=http://www.ej-technologies.com/products/jprofiler/overview.html style=text-decoration:none><img class="logo jprofiler-logo" src=https://vertx.tk/assets/jprofiler-logo.png width=48 height=48><span class=jprofiler-logo>&nbsp; JPROFILER</span></a></div></div></div></div></div></footer><script src=https://cdnjs.cloudflare.com/ajax/libs/jquery/1.9.1/jquery.min.js></script><script src=https://vertx.tk/javascripts/bootstrap.min.js></script><script src=https://vertx.tk/javascripts/highlight.pack.js></script><script>hljs.initHighlightingOnLoad();</script><link rel=stylesheet type=text/css href="//cdnjs.cloudflare.com/ajax/libs/cookieconsent2/3.0.3/cookieconsent.min.css"><script src=//cdnjs.cloudflare.com/ajax/libs/cookieconsent2/3.0.3/cookieconsent.min.js></script><script>window.addEventListener("load", function(){
window.cookieconsent.initialise({
  "palette": {
    "popup": {
      "background": "#64386b",
      "text": "#ffcdfd"
    },
    "button": {
      "background": "transparent",
      "text": "#f8a8ff",
      "border": "#f8a8ff"
    }
  },
  "content": {
    "message": "This website uses anonymous cookies to ensure we provide you the best experience. ",
    "link": "Opt out!",
    "href": "https://tools.google.com/dlpage/gaoptout/"
  }
})});</script></body></html>