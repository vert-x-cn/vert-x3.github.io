<!DOCTYPE html><html lang=en><head><title>Combine vert.x and mongo to build a giant</title><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta content="width=device-width,initial-scale=1" name=viewport><meta content="Eclipse Vert.x is a tool-kit for building reactive applications on the JVM." name=description><link href=https://okou19900722.gitee.io/cn.vertx.tk//stylesheets/main.css media=screen rel=stylesheet><link href=https://okou19900722.gitee.io/cn.vertx.tk//stylesheets/font-awesome.min.css media=screen rel=stylesheet><link href=https://okou19900722.gitee.io/cn.vertx.tk//javascripts/styles/rainbow.min.css media=screen rel=stylesheet><!--[if lt IE 9]><script src="http://static.jboss.org/theme/js/libs/html5/pre3.6/html5.min.js"></script><![endif]--><link rel=apple-touch-icon sizes=57x57 href=https://okou19900722.gitee.io/cn.vertx.tk//assets/favicons/vertx-favicon-7/apple-touch-icon-57x57.png><link rel=apple-touch-icon sizes=60x60 href=https://okou19900722.gitee.io/cn.vertx.tk//assets/favicons/vertx-favicon-7/apple-touch-icon-60x60.png><link rel=apple-touch-icon sizes=72x72 href=https://okou19900722.gitee.io/cn.vertx.tk//assets/favicons/vertx-favicon-7/apple-touch-icon-72x72.png><link rel=apple-touch-icon sizes=76x76 href=https://okou19900722.gitee.io/cn.vertx.tk//assets/favicons/vertx-favicon-7/apple-touch-icon-76x76.png><link rel=apple-touch-icon sizes=114x114 href=https://okou19900722.gitee.io/cn.vertx.tk//assets/favicons/vertx-favicon-7/apple-touch-icon-114x114.png><link rel=apple-touch-icon sizes=120x120 href=https://okou19900722.gitee.io/cn.vertx.tk//assets/favicons/vertx-favicon-7/apple-touch-icon-120x120.png><link rel=apple-touch-icon sizes=144x144 href=https://okou19900722.gitee.io/cn.vertx.tk//assets/favicons/vertx-favicon-7/apple-touch-icon-144x144.png><link rel=apple-touch-icon sizes=152x152 href=https://okou19900722.gitee.io/cn.vertx.tk//assets/favicons/vertx-favicon-7/apple-touch-icon-152x152.png><link rel=apple-touch-icon sizes=180x180 href=https://okou19900722.gitee.io/cn.vertx.tk//assets/favicons/vertx-favicon-7/apple-touch-icon-180x180.png><link rel=icon type=image/png href=https://okou19900722.gitee.io/cn.vertx.tk//assets/favicons/vertx-favicon-7/favicon-32x32.png sizes=32x32><link rel=icon type=image/png href=https://okou19900722.gitee.io/cn.vertx.tk//assets/favicons/vertx-favicon-7/android-chrome-192x192.png sizes=192x192><link rel=icon type=image/png href=https://okou19900722.gitee.io/cn.vertx.tk//assets/favicons/vertx-favicon-7/favicon-96x96.png sizes=96x96><link rel=icon type=image/png href=https://okou19900722.gitee.io/cn.vertx.tk//assets/favicons/vertx-favicon-7/favicon-16x16.png sizes=16x16><link rel=manifest href=https://okou19900722.gitee.io/cn.vertx.tk//assets/favicons/vertx-favicon-7/manifest.json><link rel=mask-icon href=https://okou19900722.gitee.io/cn.vertx.tk//assets/favicons/vertx-favicon-7/safari-pinned-tab.svg color=#5bbad5><meta name=msapplication-TileColor content=#7d3194><meta name=msapplication-TileImage content=https://okou19900722.gitee.io/cn.vertx.tk//assets/favicons/vertx-favicon-7/mstile-144x144.png><meta name=theme-color content=#ffffff><link href="https://fonts.googleapis.com/css?family=Ubuntu:400,500,700,400italic" rel=stylesheet type=text/css><link rel=alternate type=application/rss+xml title=RSS href=https://okou19900722.gitee.io/cn.vertx.tk//feed.xml><script>(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
      (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
      m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
    ga('create', 'UA-30144458-1', 'auto');
    ga('create', 'UA-71153120-1', 'auto', 'tracker');
    ga('send', 'pageview');
    ga('tracker.send', 'pageview');</script><style>.page-link-to-github {
      position: relative;
      z-index: 1;
      display: inline-block;
      border: 1px solid #782B90;
      border-radius: 5px;
      color: #782B90;
      font-size: 12px;
      padding: 4px 10px;
      text-decoration: none;
      background-color: #ffffff;
    }
    .page-link-to-github:hover {
      color: #ffffff;
      border-color: #ffffff;
      background-color: #782B90;
    }

    .page-link-to-github .github-icon {
      position: absolute;
      display: inline-block;
      width: 20px;
      height: 20px;
      /*background-position: -50px 0*/
      background: url('https://okou19900722.gitee.io/cn.vertx.tk//assets/github.png') no-repeat 0 0;
    }

    @media (-webkit-min-device-pixel-ratio: 2),(min-resolution:192dpi) {
      .page-link-to-github .github-icon {
        background-image:url('https://okou19900722.gitee.io/cn.vertx.tk//assets/github@2x.png');
        background-size: 150px auto
      }
    }

    .page-link-to-github:hover .github-icon {
      /*background-position: 0 0*/
      background-position: -100px 0
    }
    .text {
      text-decoration: underline
    }
    .page-link-to-github .text {
      padding-left: 27px
    }
    .text {
      padding-right: 8px
    }
    .page-link-to-github {
      float: right;
      top: 4px
    }</style></head><body><a href="http://www.reactivemanifesto.org/" id=reactive-manifesto-banner><img style="border: 0; position: fixed; right: 0; top:0; z-index: 9000" src=https://d379ifj7s9wntv.cloudfront.net/reactivemanifesto/images/ribbons/we-are-reactive-black-right.png></a> <a id=skippy class="sr-only sr-only-focusable" href=#content><div class=container><span class=skiplink-text>Skip to main content</span></div></a><header class="navbar navbar-default navbar-static-top" id=top role=banner><div class=container><div class=navbar-header><button class="navbar-toggle collapsed" type=button data-toggle=collapse data-target=#vertx-navbar-collapse><span class=sr-only>Toggle navigation</span> <span class=icon-bar></span> <span class=icon-bar></span> <span class=icon-bar></span></button> <a href="https://okou19900722.gitee.io/cn.vertx.tk//" class=navbar-brand><img alt=Brand src=https://okou19900722.gitee.io/cn.vertx.tk//assets/logo-sm.png></a></div><nav class="collapse navbar-collapse" id=vertx-navbar-collapse><ul class="nav navbar-nav navbar-right"><li><a href=http://start.vertx.io>Starter</a></li><li><a href=https://vertx.io>官网</a></li><li><a href="https://okou19900722.gitee.io/cn.vertx.tk//download/">下载</a></li><li><a href="https://okou19900722.gitee.io/cn.vertx.tk//docs/">文档</a></li><li><a href=https://github.com/vert-x3/wiki/wiki>维基</a></li><li><a href="https://okou19900722.gitee.io/cn.vertx.tk//community/">社区</a></li><li><a href="https://okou19900722.gitee.io/cn.vertx.tk//materials/">资料</a></li><li><a href="https://okou19900722.gitee.io/cn.vertx.tk//blog/">博客</a></li></ul></nav></div></header><div class=container><div class="row blog"><article class="col-xs-12 blog-post"><h2 class=blog-post-title>Combine vert.x and mongo to build a giant</h2><p class=blog-post-meta>30th November 2015 by <a href=http://github.com/cescoffier>cescoffier</a></p><article><p>This blog post is part of the <em>introduction to vert.x</em> series. Last time, we have seen how we can use the <code>vertx-jdbc-client</code> to connect to a database using a JDBC driver. In this post, we are going to replace this JDBC client by the <code>vertx-mongo-client</code>, and thus connect to a Mongo database.</p><p>You don’t understand the title, check the <a href=https://www.mongodb.org>mongoDB</a> website.</p><p>But before going further, let’s recap.</p><h2 id=previously-in-introduction-to-vert-x->Previously in ‘introduction to vert.x’</h2><ol><li>The <a href="https://okou19900722.gitee.io/cn.vertx.tk//blog/my-first-vert-x-3-application/">first post</a> has described how to build a vert.x application with Maven and execute unit tests.</li><li>The <a href="https://okou19900722.gitee.io/cn.vertx.tk//blog/vert-x-application-configuration/">second post</a> has described how this application can become configurable.</li><li>The <a href="https://okou19900722.gitee.io/cn.vertx.tk//blog/some-rest-with-vert-x/">third post</a> has introduced <a href="http://vertx.io/docs/vertx-web/java/">vertx-web</a>, and a small collection management application has been developed. This application offers a REST API used by a HTML/JavaScript frontend.</li><li>The <a href="https://okou19900722.gitee.io/cn.vertx.tk//blog/unit-and-integration-tests/">fourth post</a> has presented how you can run integration tests to ensure the behavior of your application.</li><li>The <a href="https://okou19900722.gitee.io/cn.vertx.tk//blog/using-the-asynchronous-sql-client/">last post</a> has presented how you can interact with a JDBC database using the vertx-jdbc-client.</li></ol><p>This post shows another client that lets you use MongoDB in a vert.x application. This client provides an vert.x API to access asynchronously to the Mongo database. We won’t compare whether or not JDBC is superior to Mongo, they have both pros and cons, and you should use the one that meet your requirements. Vert.x lets you choose, that’s the point.</p><p>The vertx-mongo-client documentation is available <a href="http://vertx.io/docs/vertx-mongo-client/java/">here</a>.</p><p>The code developed in this blog post is available in the branch <a href=https://github.com/cescoffier/my-vertx-first-app/tree/post-6>post-6</a>. Our starting point is the code from the <a href=https://github.com/cescoffier/my-vertx-first-app/tree/post-5>post-5 branch</a>.</p><h2 id=asynchronous-data-access>Asynchronous data access</h2><p>One of the vert.x characteristics is being asynchronous. With an asynchronous API, you don’t wait for a result, but you are notified when this result is ready. Thanks to vert.x, this notification happens in the same thread (understand event loop) as the initial request:</p><p><img src=/assets/blog/intro-series/async-data.png alt="Asynchronous data access"></p><p>Your code (on the left) is going to invoke the mongo client and pass a callback that will be invoked when the result is available. The invocation to the mongo client is non blocking and returns immediately. The client is dealing with the mongo database and when the result has been computed / retrieved, it invokes the callback in the same event loop as the request.</p><p>This model is particularly powerful as it avoids the synchronization pitfalls. Indeed, your code is only called by a single thread, no need to synchronize anything.</p><h2 id=as-with-every-maven-project->As with every Maven project….</h2><p>… we need to update the <code>pom.xml</code> file first.</p><p>In the <code>pom.xml</code> file, replace the <code>vertx-jdbc-client</code> by the <code>vertx-mongo-client</code>:</p><pre><code class="hljs xml"><span class=hljs-tag>&lt;<span class=hljs-title>dependency</span>&gt;</span>
      <span class=hljs-tag>&lt;<span class=hljs-title>groupId</span>&gt;</span>io.vertx<span class=hljs-tag>&lt;/<span class=hljs-title>groupId</span>&gt;</span>
      <span class=hljs-tag>&lt;<span class=hljs-title>artifactId</span>&gt;</span>vertx-mongo-client<span class=hljs-tag>&lt;/<span class=hljs-title>artifactId</span>&gt;</span>
      <span class=hljs-tag>&lt;<span class=hljs-title>version</span>&gt;</span>3.1.0<span class=hljs-tag>&lt;/<span class=hljs-title>version</span>&gt;</span>
    <span class=hljs-tag>&lt;/<span class=hljs-title>dependency</span>&gt;</span></code></pre><p>Unlike JDBC where we were instantiating a database on the fly, here we need to explicitly starts a MongoDB server. In order to launch a Mongo server in our test, we are going to add another dependency:</p><pre><code class="hljs xml"><span class=hljs-tag>&lt;<span class=hljs-title>dependency</span>&gt;</span>
      <span class=hljs-tag>&lt;<span class=hljs-title>groupId</span>&gt;</span>de.flapdoodle.embed<span class=hljs-tag>&lt;/<span class=hljs-title>groupId</span>&gt;</span>
      <span class=hljs-tag>&lt;<span class=hljs-title>artifactId</span>&gt;</span>de.flapdoodle.embed.mongo<span class=hljs-tag>&lt;/<span class=hljs-title>artifactId</span>&gt;</span>
      <span class=hljs-tag>&lt;<span class=hljs-title>version</span>&gt;</span>1.50.0<span class=hljs-tag>&lt;/<span class=hljs-title>version</span>&gt;</span>
      <span class=hljs-tag>&lt;<span class=hljs-title>scope</span>&gt;</span>test<span class=hljs-tag>&lt;/<span class=hljs-title>scope</span>&gt;</span>
    <span class=hljs-tag>&lt;/<span class=hljs-title>dependency</span>&gt;</span></code></pre><p>This dependency will be used in our unit tests, as it lets us start a mongo server programmatically. For our integration tests, we are going to use a Maven plugin starting and stopping the mongo server before and after our integration tests. Add this plugin to the <code>&lt;plugins/&gt;</code> section of your <code>pom.xml</code> file.</p><pre><code class="hljs xml"><span class=hljs-tag>&lt;<span class=hljs-title>plugin</span>&gt;</span>
        <span class=hljs-tag>&lt;<span class=hljs-title>groupId</span>&gt;</span>com.github.joelittlejohn.embedmongo<span class=hljs-tag>&lt;/<span class=hljs-title>groupId</span>&gt;</span>
        <span class=hljs-tag>&lt;<span class=hljs-title>artifactId</span>&gt;</span>embedmongo-maven-plugin<span class=hljs-tag>&lt;/<span class=hljs-title>artifactId</span>&gt;</span>
        <span class=hljs-tag>&lt;<span class=hljs-title>version</span>&gt;</span>0.2.0<span class=hljs-tag>&lt;/<span class=hljs-title>version</span>&gt;</span>
        <span class=hljs-tag>&lt;<span class=hljs-title>executions</span>&gt;</span>
          <span class=hljs-tag>&lt;<span class=hljs-title>execution</span>&gt;</span>
            <span class=hljs-tag>&lt;<span class=hljs-title>id</span>&gt;</span>start<span class=hljs-tag>&lt;/<span class=hljs-title>id</span>&gt;</span>
            <span class=hljs-tag>&lt;<span class=hljs-title>goals</span>&gt;</span>
              <span class=hljs-tag>&lt;<span class=hljs-title>goal</span>&gt;</span>start<span class=hljs-tag>&lt;/<span class=hljs-title>goal</span>&gt;</span>
            <span class=hljs-tag>&lt;/<span class=hljs-title>goals</span>&gt;</span>
            <span class=hljs-tag>&lt;<span class=hljs-title>configuration</span>&gt;</span>
              <span class=hljs-tag>&lt;<span class=hljs-title>port</span>&gt;</span>37017<span class=hljs-tag>&lt;/<span class=hljs-title>port</span>&gt;</span>
            <span class=hljs-tag>&lt;/<span class=hljs-title>configuration</span>&gt;</span>
          <span class=hljs-tag>&lt;/<span class=hljs-title>execution</span>&gt;</span>
          <span class=hljs-tag>&lt;<span class=hljs-title>execution</span>&gt;</span>
            <span class=hljs-tag>&lt;<span class=hljs-title>id</span>&gt;</span>stop<span class=hljs-tag>&lt;/<span class=hljs-title>id</span>&gt;</span>
            <span class=hljs-tag>&lt;<span class=hljs-title>goals</span>&gt;</span>
              <span class=hljs-tag>&lt;<span class=hljs-title>goal</span>&gt;</span>stop<span class=hljs-tag>&lt;/<span class=hljs-title>goal</span>&gt;</span>
            <span class=hljs-tag>&lt;/<span class=hljs-title>goals</span>&gt;</span>
          <span class=hljs-tag>&lt;/<span class=hljs-title>execution</span>&gt;</span>
        <span class=hljs-tag>&lt;/<span class=hljs-title>executions</span>&gt;</span>
    <span class=hljs-tag>&lt;/<span class=hljs-title>plugin</span>&gt;</span></code></pre><p>Notice the port we use here (37017), we will use this port later.</p><h2 id=enough-xml-for-today>Enough XML for today</h2><p>Now that we have updated our <code>pom.xml</code> file, it’s time to change our verticle. The first thing to do is to replace the jdbc client by the mongo client:</p><pre><code class="hljs java">mongo = MongoClient.createShared(vertx, config());</code></pre><p>This client is configured with the configuration given to the verticle (more on this below).</p><p>Once done, we need to change how we start the application. With the mongo client, no need to acquire a connection, it handles this internally. So our startup sequence is a bit more simple:</p><pre><code class="hljs java">createSomeData(
        (nothing) -&gt; startWebApp(
            (http) -&gt; completeStartup(http, fut)
        ), fut);</code></pre><p>As in the previous post, we need to insert some predefined data if the database is empty:</p><pre><code class="hljs java"><span class=hljs-function><span class=hljs-keyword>private</span> <span class=hljs-keyword>void</span> <span class=hljs-title>createSomeData</span><span class=hljs-params>(Handler&lt;AsyncResult&lt;Void&gt;&gt; next, Future&lt;Void&gt; fut)</span> </span>{
    Whisky bowmore = <span class=hljs-keyword>new</span> Whisky(<span class=hljs-string>"Bowmore 15 Years Laimrig"</span>, <span class=hljs-string>"Scotland, Islay"</span>);
    Whisky talisker = <span class=hljs-keyword>new</span> Whisky(<span class=hljs-string>"Talisker 57° North"</span>, <span class=hljs-string>"Scotland, Island"</span>);
    System.out.println(bowmore.toJson());
    <span class=hljs-comment>// Do we have data in the collection ?</span>
    mongo.count(COLLECTION, <span class=hljs-keyword>new</span> JsonObject(), count -&gt; {
      <span class=hljs-keyword>if</span> (count.succeeded()) {
        <span class=hljs-keyword>if</span> (count.result() == <span class=hljs-number>0</span>) {
          <span class=hljs-comment>// no whiskies, insert data</span>
          mongo.insert(COLLECTION, bowmore.toJson(), ar -&gt; {
            <span class=hljs-keyword>if</span> (ar.failed()) {
              fut.fail(ar.cause());
            } <span class=hljs-keyword>else</span> {
              mongo.insert(COLLECTION, talisker.toJson(), ar2 -&gt; {
                <span class=hljs-keyword>if</span> (ar2.failed()) {
                  fut.failed();
                } <span class=hljs-keyword>else</span> {
                  next.handle(Future.&lt;Void&gt;succeededFuture());
                }
              });
            }
          });
        } <span class=hljs-keyword>else</span> {
          next.handle(Future.&lt;Void&gt;succeededFuture());
        }
      } <span class=hljs-keyword>else</span> {
        <span class=hljs-comment>// report the error</span>
        fut.fail(count.cause());
      }
    });
}</code></pre><p>To detect whether or not the database already contains some data, we retrieve the number of <em>documents</em> from the <code>whiskies</code> collection. This is done with : <code>mongo.count(COLLECTION, new JsonObject(), count -&gt; {})</code>. The second parameter is the query. In our case, we want to count all documents. This is done using <code>new JsonObject()</code> that would create a query accepting all documents from the collection (it’s equivalent to a <code>SELECT * FROM ...</code>).</p><p>Also notice the <code>insert</code> calls. Documents are passed as JSON object, so to insert an object, just serialize it to JSON and use <code>mongo.insert(COLLECTION, json, completion handler)</code>.</p><h2 id=mongo-ize-the-rest-handlers>Mongo-ize the REST handlers</h2><p>Now that the application boot sequence has been migrated to mongo, it’s time to update the code handling the REST requests.</p><p>Let’s start by the <code>getAll</code> method that returns all stored products. To implement this, we use the <code>find</code> method. As we saw for the <code>count</code> method, we pass an empty json object to describe a query accepting all documents:</p><pre><code class="hljs java"><span class=hljs-function><span class=hljs-keyword>private</span> <span class=hljs-keyword>void</span> <span class=hljs-title>getAll</span><span class=hljs-params>(RoutingContext routingContext)</span> </span>{
    mongo.find(COLLECTION, <span class=hljs-keyword>new</span> JsonObject(), results -&gt; {
      List&lt;JsonObject&gt; objects = results.result();
      List&lt;Whisky&gt; whiskies = objects.stream().map(Whisky::<span class=hljs-keyword>new</span>).collect(Collectors.toList());
      routingContext.response()
          .putHeader(<span class=hljs-string>"content-type"</span>, <span class=hljs-string>"application/json; charset=utf-8"</span>)
          .end(Json.encodePrettily(whiskies));
    });
}</code></pre><p>The query results are passed as a list of JSON objects. From this list we can create our product instances, and fill the HTTP response with this set.</p><p>To delete a specific document we need to select the document using its <code>id</code>:</p><pre><code class="hljs java"><span class=hljs-function><span class=hljs-keyword>private</span> <span class=hljs-keyword>void</span> <span class=hljs-title>deleteOne</span><span class=hljs-params>(RoutingContext routingContext)</span> </span>{
    String id = routingContext.request().getParam(<span class=hljs-string>"id"</span>);
    <span class=hljs-keyword>if</span> (id == <span class=hljs-keyword>null</span>) {
      routingContext.response().setStatusCode(<span class=hljs-number>400</span>).end();
    } <span class=hljs-keyword>else</span> {
      mongo.removeOne(COLLECTION, <span class=hljs-keyword>new</span> JsonObject().put(<span class=hljs-string>"_id"</span>, id),
          ar -&gt; routingContext.response().setStatusCode(<span class=hljs-number>204</span>).end());
    }
}</code></pre><p>The <code>new JsonObject().put(&quot;_id&quot;, id)</code> describes a query selecting a single document (selected by its unique <code>id</code>, so it’s the equivalent to <code>SELECT * WHERE id=...</code>). Notice the <code>_id</code> which is a mongo trick to select a document by id.</p><p>Updating a document is a less trivial:</p><pre><code class="hljs java"><span class=hljs-function><span class=hljs-keyword>private</span> <span class=hljs-keyword>void</span> <span class=hljs-title>updateOne</span><span class=hljs-params>(RoutingContext routingContext)</span> </span>{
    <span class=hljs-keyword>final</span> String id = routingContext.request().getParam(<span class=hljs-string>"id"</span>);
    JsonObject json = routingContext.getBodyAsJson();
    <span class=hljs-keyword>if</span> (id == <span class=hljs-keyword>null</span> || json == <span class=hljs-keyword>null</span>) {
      routingContext.response().setStatusCode(<span class=hljs-number>400</span>).end();
    } <span class=hljs-keyword>else</span> {
      mongo.update(COLLECTION,
          <span class=hljs-keyword>new</span> JsonObject().put(<span class=hljs-string>"_id"</span>, id), <span class=hljs-comment>// Select a unique document</span>
          <span class=hljs-comment>// The update syntax: {$set, the json object containing the fields to update}</span>
          <span class=hljs-keyword>new</span> JsonObject()
              .put(<span class=hljs-string>"$set"</span>, json),
          v -&gt; {
            <span class=hljs-keyword>if</span> (v.failed()) {
              routingContext.response().setStatusCode(<span class=hljs-number>404</span>).end();
            } <span class=hljs-keyword>else</span> {
              routingContext.response()
                  .putHeader(<span class=hljs-string>"content-type"</span>, <span class=hljs-string>"application/json; charset=utf-8"</span>)
                  .end(Json.encodePrettily(
                  <span class=hljs-keyword>new</span> Whisky(id, json.getString(<span class=hljs-string>"name"</span>),
                    json.getString(<span class=hljs-string>"origin"</span>))));
            }
          });
    }
}</code></pre><p>As we can see, the <code>update</code> method takes two JSON objects as parameter:</p><ol><li>The first one denotes the query (here we select a single document using its id).</li><li>The second object expresses the change to apply to the selected document. It uses a mongo syntax. In our case, we update the document using the <code>$set</code> operator.</li></ol><p><div class="admonition-block note"><table><tbody><tr><td class=admonition-icon><i class="admonition-icon fa fa-comment"></i></td><td class=content><span class=title>Replace document</span><br><span class=content>In this code we update the document and replace only a set of fields. You can also replace the whole document using <code>mongo.replace(...)</code>.</span></td></tr></tbody></table></div></p><p>I definitely recommend to have a look to the MongoDB documentation, especially:</p><ul><li><a href="https://docs.mongodb.org/manual/tutorial/query-documents/" title="MongoDB Query Documentation">Query syntax documentation</a></li><li><a href="https://docs.mongodb.org/manual/tutorial/modify-documents/" title="MongoDB Update Documentation">Update syntax documentation</a></li></ul><h2 id=time-for-configuration>Time for configuration</h2><p>Well, the code is migrated, but we still need to update the configuration. With JDBC we passed the JDBC url and the driver class in the configuration. With mongo, we need to configure the <code>connection_string</code> - the <code>mongo://</code> url on which the application is connected, and <code>db_name</code> - a name for the data source.</p><p>Let’s start by the unit test. Edit the <code>MyFirstVerticleTest</code> file and add the following code:</p><pre><code class="hljs java"><span class=hljs-keyword>private</span> <span class=hljs-keyword>static</span> MongodProcess MONGO;
    <span class=hljs-keyword>private</span> <span class=hljs-keyword>static</span> <span class=hljs-keyword>int</span> MONGO_PORT = <span class=hljs-number>12345</span>;
    <span class=hljs-annotation>@BeforeClass</span>
    <span class=hljs-function><span class=hljs-keyword>public</span> <span class=hljs-keyword>static</span> <span class=hljs-keyword>void</span> <span class=hljs-title>initialize</span><span class=hljs-params>()</span> <span class=hljs-keyword>throws</span> IOException </span>{
      MongodStarter starter = MongodStarter.getDefaultInstance();
      IMongodConfig mongodConfig = <span class=hljs-keyword>new</span> MongodConfigBuilder()
          .version(Version.Main.PRODUCTION)
          .net(<span class=hljs-keyword>new</span> Net(MONGO_PORT, Network.localhostIsIPv6()))
          .build();
      MongodExecutable mongodExecutable =
            starter.prepare(mongodConfig);
     MONGO = mongodExecutable.start();
    }

    <span class=hljs-annotation>@AfterClass</span>
    <span class=hljs-function><span class=hljs-keyword>public</span> <span class=hljs-keyword>static</span> <span class=hljs-keyword>void</span> <span class=hljs-title>shutdown</span><span class=hljs-params>()</span> </span>{  MONGO.stop(); }</code></pre><p>Before our tests, we start (programmatically) a mongo database on the port 12345. When all our tests have been executed, we shutdown the database.</p><p>So now that the mongo server is managed, we need to to give the right configuration to our verticle. Update the <code>DeploymentOption</code> instance with:</p><pre><code class="hljs java">DeploymentOptions options = <span class=hljs-keyword>new</span> DeploymentOptions()
        .setConfig(<span class=hljs-keyword>new</span> JsonObject()
            .put(<span class=hljs-string>"http.port"</span>, port)
            .put(<span class=hljs-string>"db_name"</span>, <span class=hljs-string>"whiskies-test"</span>)
            .put(<span class=hljs-string>"connection_string"</span>,
                <span class=hljs-string>"mongodb://localhost:"</span> + MONGO_PORT)
    );</code></pre><p>That’s all for the unit tests.</p><p>For the integration-test, we are using an externalized json file. Edit the <code>src/test/resources/my-it-config.json</code> with the following content:</p><pre><code class=hljs>{
      <span class=hljs-string>"http.port"</span>: <span class=hljs-variable>${http.port}</span>,
      <span class=hljs-string>"db_name"</span>: <span class=hljs-string>"whiskies-it"</span>,
      <span class=hljs-string>"connection_string"</span>: <span class=hljs-string>"mongodb://localhost:37017"</span>
    }</code></pre><p>Notice the port we are using for the mongo server. This port was configured in the <code>pom.xml</code> file.</p><p>Last but not least, we still have a configuration file to edit: the configuration you use to launch the application in <code>production</code>:</p><pre><code class=hljs>{
      "<span class=hljs-attribute>http.port</span>": <span class=hljs-value><span class=hljs-number>8082</span></span>,
      "<span class=hljs-attribute>db_name</span>": <span class=hljs-value><span class=hljs-string>"whiskies"</span></span>,
      "<span class=hljs-attribute>connection_string</span>": <span class=hljs-value><span class=hljs-string>"mongodb://localhost:27017"</span>
    </span>}</code></pre><p>Here you would need to edit the <code>localhost:27017</code> with the right url for your mongo server.</p><p><div class="admonition-block note"><table><tbody><tr><td class=admonition-icon><i class="admonition-icon fa fa-comment"></i></td><td class=content><span class=title>Some changes in the integration tests</span><br><span class=content>Because mongo document id are String and not integer, we have to slightly change document selection in the integration test.</span></td></tr></tbody></table></div></p><h2 id=time-for-a-run>Time for a run</h2><p>It’s time to package and run the application and check that everything works as expected. Let’s package the application using:</p><pre><code class=hljs>mvn clean <span class=hljs-built_in>verify</span></code></pre><p>And then to launch it, start your mongo server and launch:</p><pre><code class=hljs>java -jar target/<span class=hljs-keyword>my</span>-<span class=hljs-keyword>first</span>-app-<span class=hljs-number>1.0</span>-SNAPSHOT-fat.jar \
  -conf src/main/conf/<span class=hljs-keyword>my</span>-<span class=hljs-type>application</span>-conf.json</code></pre><p>If you are, like me, using docker / docker-machine for almost everything, edit the configuration file to refer to the right host (localhost for docker, the docker-machine ip if you use docker-machine) and then launch:</p><pre><code class=hljs>docker <span class=hljs-command>run</span> -d -p <span class=hljs-number>27017</span>:<span class=hljs-number>27017</span> mongo
java -jar target/<span class=hljs-keyword>my</span>-<span class=hljs-keyword>first</span>-app-<span class=hljs-number>1.0</span>-SNAPSHOT-fat.jar \
  -conf src/main/conf/<span class=hljs-keyword>my</span>-<span class=hljs-type>application</span>-conf.json
<span class=hljs-comment># or</span>
java -jar target/<span class=hljs-keyword>my</span>-<span class=hljs-keyword>first</span>-app-<span class=hljs-number>1.0</span>-SNAPSHOT-fat.jar \
  -conf src/main/conf/<span class=hljs-keyword>my</span>-<span class=hljs-type>application</span>-conf-docker-machine.json</code></pre><p><img src=/assets/blog/intro-series/whisky-mongo.png alt="The application live and running"></p><h2 id=that-s-all-folks->That’s all folks !</h2><p>We are reaching the end of this post. We saw how you can use the vert-mongo-client to access asynchronously data stored inside a mongo database as well as inserting/updating this data. Now you have the choice between JDBC or Mongo. In addition, vert.x provides a client for Redis.</p><p>Next time, we will see how the verticle class can be split in two verticles in order to better organize your code. The interaction between the two verticles will uses <em>services</em>.</p><p>Stay tuned &amp; Happy coding !</p></article></article></div><div class=row><div class=col-xs-12 id=disqus_thread></div></div><script>var disqus_config = function () {
  this.page.url = "https://okou19900722.gitee.io/cn.vertx.tk//blog/combine-vert-x-and-mongo-to-build-a-giant/";
  this.page.identifier = "/blog/combine-vert-x-and-mongo-to-build-a-giant/";
  };
  (function() { // DON'T EDIT BELOW THIS LINE
  var d = document, s = d.createElement('script');
  s.src = 'https://vertx.disqus.com/embed.js';
  s.setAttribute('data-timestamp', +new Date());
  (d.head || d.body).appendChild(s);
  })();</script><noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript></div><footer><div class=container><div class=row><div class="col-xs-4 col-sm-4 col-md-2 col-lg-2"><h2>Eclipse Vert.x</h2><ul class=list-unstyled><li><a href="https://okou19900722.gitee.io/cn.vertx.tk//">主页</a></li><li><a href="https://okou19900722.gitee.io/cn.vertx.tk//download/">下载</a></li><li><a href="https://okou19900722.gitee.io/cn.vertx.tk//docs/">文档</a></li><li><a href=https://github.com/vert-x3/wiki/wiki>维基</a></li><li><a href="https://okou19900722.gitee.io/cn.vertx.tk//blog/">博客</a></li></ul></div><div class="col-xs-4 col-sm-4 col-md-2 col-lg-2"><h2>Community</h2><ul class=list-unstyled><li><a href="https://okou19900722.gitee.io/cn.vertx.tk//community/">帮助 &amp; 贡献者</a></li><li><a href="https://okou19900722.gitee.io/cn.vertx.tk//materials/">学习资料</a></li><li><a href=https://groups.google.com/forum/?fromgroups#!forum/vertx>User Group</a></li><li><a href=https://groups.google.com/forum/?fromgroups#!forum/vertx-dev>Developer Group</a></li><li><a href="//shang.qq.com/wpa/qunwpa?idkey=587f58cacb9557e3291b46098e0fe09427b98a1c0f866da23c04c2762bc7e2ad">QQ群</a></li></ul></div><div class="col-xs-4 col-sm-4 col-md-2 col-lg-2"><h2>Eclipse</h2><ul class=list-unstyled><li><a href="http://www.eclipse.org/">Eclipse Foundation</a></li><li><a href=https://eclipse.org/legal/privacy.php>Privacy Policy</a></li><li><a href=https://eclipse.org/legal/termsofuse.php>Terms of Use</a></li><li><a href=https://eclipse.org/legal/copyright.php>Copyright Agent</a></li><li><a href=http://www.eclipse.org/legal>Legal Resources</a></li></ul></div><div class="col-xs-12 col-sm-12 col-md-6 col-lg-6 copyright"><p>Eclipse Vert.x is open source and dual-licensed under the <a href=http://www.eclipse.org/legal/epl-v20.html>Eclipse Public License 2.0</a> and <a href=https://www.apache.org/licenses/LICENSE-2.0.html>Apache License 2.0</a>.</p><p>This website is licensed under the <a href="http://creativecommons.org/licenses/by-sa/3.0/">CC BY-SA 3.0 License</a>.<br>Design by <a href=https://www.michel-kraemer.com>Michel Kr&auml;mer</a>.</p><div class=row><div class="col-sm-12 col-md-5 col-md-offset-1 col-lg-offset-2"><a href=http://eclipse.org><img class="logo eclipse-logo" src=https://okou19900722.gitee.io/cn.vertx.tk//assets/eclipse_logo_grey_small.png width=204 height=48></a></div><div class="col-sm-12 col-md-5 col-md-offset-1 col-lg-offset-0"><a href=http://cloudbees.com><img class="logo cloudbees-logo" src=https://okou19900722.gitee.io/cn.vertx.tk//assets/Button-Built-on-CB-1-grey.png width=180 height=48></a></div><div class="col-sm-12 col-md-5 col-md-offset-7 jprofiler"><a href=http://www.ej-technologies.com/products/jprofiler/overview.html style=text-decoration:none><img class="logo jprofiler-logo" src=https://okou19900722.gitee.io/cn.vertx.tk//assets/jprofiler-logo.png width=48 height=48><span class=jprofiler-logo>&nbsp; JPROFILER</span></a></div></div></div></div></div></footer><script src=https://cdnjs.cloudflare.com/ajax/libs/jquery/1.9.1/jquery.min.js></script><script src=https://okou19900722.gitee.io/cn.vertx.tk//javascripts/bootstrap.min.js></script><script src=https://okou19900722.gitee.io/cn.vertx.tk//javascripts/highlight.pack.js></script><script>hljs.initHighlightingOnLoad();</script><link rel=stylesheet type=text/css href="//cdnjs.cloudflare.com/ajax/libs/cookieconsent2/3.0.3/cookieconsent.min.css"><script src=//cdnjs.cloudflare.com/ajax/libs/cookieconsent2/3.0.3/cookieconsent.min.js></script><script>window.addEventListener("load", function(){
window.cookieconsent.initialise({
  "palette": {
    "popup": {
      "background": "#64386b",
      "text": "#ffcdfd"
    },
    "button": {
      "background": "transparent",
      "text": "#f8a8ff",
      "border": "#f8a8ff"
    }
  },
  "content": {
    "message": "This website uses anonymous cookies to ensure we provide you the best experience. ",
    "link": "Opt out!",
    "href": "https://tools.google.com/dlpage/gaoptout/"
  }
})});</script></body></html>