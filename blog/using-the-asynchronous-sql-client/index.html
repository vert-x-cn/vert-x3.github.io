<!DOCTYPE html><html lang=en><head><title>Using the asynchronous SQL client</title><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta content="width=device-width,initial-scale=1" name=viewport><meta content="Eclipse Vert.x is a tool-kit for building reactive applications on the JVM." name=description><link href=https://vertx.tk/stylesheets/main.css media=screen rel=stylesheet><link href=https://vertx.tk/stylesheets/font-awesome.min.css media=screen rel=stylesheet><link href=https://vertx.tk/javascripts/styles/rainbow.min.css media=screen rel=stylesheet><!--[if lt IE 9]><script src="http://static.jboss.org/theme/js/libs/html5/pre3.6/html5.min.js"></script><![endif]--><link rel=apple-touch-icon sizes=57x57 href=https://vertx.tk/assets/favicons/vertx-favicon-7/apple-touch-icon-57x57.png><link rel=apple-touch-icon sizes=60x60 href=https://vertx.tk/assets/favicons/vertx-favicon-7/apple-touch-icon-60x60.png><link rel=apple-touch-icon sizes=72x72 href=https://vertx.tk/assets/favicons/vertx-favicon-7/apple-touch-icon-72x72.png><link rel=apple-touch-icon sizes=76x76 href=https://vertx.tk/assets/favicons/vertx-favicon-7/apple-touch-icon-76x76.png><link rel=apple-touch-icon sizes=114x114 href=https://vertx.tk/assets/favicons/vertx-favicon-7/apple-touch-icon-114x114.png><link rel=apple-touch-icon sizes=120x120 href=https://vertx.tk/assets/favicons/vertx-favicon-7/apple-touch-icon-120x120.png><link rel=apple-touch-icon sizes=144x144 href=https://vertx.tk/assets/favicons/vertx-favicon-7/apple-touch-icon-144x144.png><link rel=apple-touch-icon sizes=152x152 href=https://vertx.tk/assets/favicons/vertx-favicon-7/apple-touch-icon-152x152.png><link rel=apple-touch-icon sizes=180x180 href=https://vertx.tk/assets/favicons/vertx-favicon-7/apple-touch-icon-180x180.png><link rel=icon type=image/png href=https://vertx.tk/assets/favicons/vertx-favicon-7/favicon-32x32.png sizes=32x32><link rel=icon type=image/png href=https://vertx.tk/assets/favicons/vertx-favicon-7/android-chrome-192x192.png sizes=192x192><link rel=icon type=image/png href=https://vertx.tk/assets/favicons/vertx-favicon-7/favicon-96x96.png sizes=96x96><link rel=icon type=image/png href=https://vertx.tk/assets/favicons/vertx-favicon-7/favicon-16x16.png sizes=16x16><link rel=manifest href=https://vertx.tk/assets/favicons/vertx-favicon-7/manifest.json><link rel=mask-icon href=https://vertx.tk/assets/favicons/vertx-favicon-7/safari-pinned-tab.svg color=#5bbad5><meta name=msapplication-TileColor content=#7d3194><meta name=msapplication-TileImage content=https://vertx.tk/assets/favicons/vertx-favicon-7/mstile-144x144.png><meta name=theme-color content=#ffffff><link href="https://fonts.googleapis.com/css?family=Ubuntu:400,500,700,400italic" rel=stylesheet type=text/css><link rel=alternate type=application/rss+xml title=RSS href=https://vertx.tk/feed.xml><script>(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
      (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
      m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
    ga('create', 'UA-30144458-1', 'auto');
    ga('create', 'UA-71153120-1', 'auto', 'tracker');
    ga('send', 'pageview');
    ga('tracker.send', 'pageview');</script><style>.page-link-to-github {
      position: relative;
      z-index: 1;
      display: inline-block;
      border: 1px solid #782B90;
      border-radius: 5px;
      color: #782B90;
      font-size: 12px;
      padding: 4px 10px;
      text-decoration: none;
      background-color: #ffffff;
    }
    .page-link-to-github:hover {
      color: #ffffff;
      border-color: #ffffff;
      background-color: #782B90;
    }

    .page-link-to-github .github-icon {
      position: absolute;
      display: inline-block;
      width: 20px;
      height: 20px;
      /*background-position: -50px 0*/
      background: url('https://vertx.tk/assets/github.png') no-repeat 0 0;
    }

    @media (-webkit-min-device-pixel-ratio: 2),(min-resolution:192dpi) {
      .page-link-to-github .github-icon {
        background-image:url('https://vertx.tk/assets/github@2x.png');
        background-size: 150px auto
      }
    }

    .page-link-to-github:hover .github-icon {
      /*background-position: 0 0*/
      background-position: -100px 0
    }
    .text {
      text-decoration: underline
    }
    .page-link-to-github .text {
      padding-left: 27px
    }
    .text {
      padding-right: 8px
    }
    .page-link-to-github {
      float: right;
      top: 4px
    }</style></head><body><a href="http://www.reactivemanifesto.org/" id=reactive-manifesto-banner><img style="border: 0; position: fixed; right: 0; top:0; z-index: 9000" src=https://d379ifj7s9wntv.cloudfront.net/reactivemanifesto/images/ribbons/we-are-reactive-black-right.png></a> <a id=skippy class="sr-only sr-only-focusable" href=#content><div class=container><span class=skiplink-text>Skip to main content</span></div></a><header class="navbar navbar-default navbar-static-top" id=top role=banner><div class=container><div class=navbar-header><button class="navbar-toggle collapsed" type=button data-toggle=collapse data-target=#vertx-navbar-collapse><span class=sr-only>Toggle navigation</span> <span class=icon-bar></span> <span class=icon-bar></span> <span class=icon-bar></span></button> <a href="https://vertx.tk/" class=navbar-brand><img alt=Brand src=https://vertx.tk/assets/logo-sm.png></a></div><nav class="collapse navbar-collapse" id=vertx-navbar-collapse><ul class="nav navbar-nav navbar-right"><li><a href=http://start.vertx.io>Starter</a></li><li><a href=https://vertx.io>官网</a></li><li><a href="https://vertx.tk/download/">下载</a></li><li><a href="https://vertx.tk/docs/">文档</a></li><li><a href=https://github.com/vert-x3/wiki/wiki>维基</a></li><li><a href="https://vertx.tk/community/">社区</a></li><li><a href="https://vertx.tk/materials/">资料</a></li><li><a href="https://vertx.tk/blog/">博客</a></li></ul></nav></div></header><div class=container><div class="row blog"><article class="col-xs-12 blog-post"><h2 class=blog-post-title>Using the asynchronous SQL client</h2><p class=blog-post-meta>19th October 2015 by <a href=http://github.com/cescoffier>cescoffier</a></p><article><p>Finally, back… This post is the fifth post of the introduction to vert.x blog series, after a not-that-small break. In this post we are going to see how we can use JDBC in a vert.x application, and this, using the asynchronous API provided by the <a href="http://vertx.io/docs/vertx-jdbc-client/java/">vertx-jdbc-client</a>.</p><h2 id=previously-in-the-introduction-to-vert-x-series>Previously in the introduction to vert.x series</h2><p>As it was quite some time since the last post, let’s start by refreshing our mind about the four previous posts:</p><ol><li>The <a href="https://vertx.tk/blog/my-first-vert-x-3-application/">first post</a> has described how to build a vert.x application with Maven and execute unit tests.</li><li>The <a href="https://vertx.tk/blog/vert-x-application-configuration/">second post</a> has described how this application can become configurable.</li><li>The <a href="https://vertx.tk/blog/some-rest-with-vert-x/">third post</a> has introduced <a href="http://vertx.io/docs/vertx-web/java/">vertx-web</a>, and a small collection management application has been developed. This application offers a REST API used by a HTML/JavaScript frontend.</li><li>The <a href="https://vertx.tk/blog/unit-and-integration-tests/">previous post</a> has presented how you can run integration tests to ensure the behavior of your application.</li></ol><p>In this post, back to code. The current application uses an in-memory map to store the products. It’s time to use a database. In this post we are going to use <a href="http://hsqldb.org/">HSQL</a>, but you can use any database providing a JDBC driver. Interactions with the database will be asynchronous and made using the <a href="http://vertx.io/docs/vertx-jdbc-client/java/">vertx-jdbc-client</a>.</p><p>The code of this post are available on this Github <a href=https://github.com/cescoffier/my-vertx-first-app>project</a>, in the <a href=https://github.com/cescoffier/my-vertx-first-app/tree/post-5>post-5 branch</a> branch.</p><h2 id=asynchronous->Asynchronous?</h2><p>One of the vert.x characteristics is being asynchronous. With an asynchronous API, you don’t wait for a result, but you are notified when this result is ready. Just to illustrate this, let’s take a very simple example.</p><p>Let’s imagine an <code>add</code> method. Traditionally, you would use it like this: <code>int r = add(1, 1)</code>. This is a synchronous API as you are waiting for the result. An asynchronous version of this API would be: <code>add(1, 1, r -&gt; { /* do something with the result */ })</code>. In this version, you pass a <code>Handler</code> called when the result has been computed. The method does not return anything, and could be implemented as:</p><pre><code class=hljs><span class=hljs-function><span class=hljs-keyword>public</span> <span class=hljs-keyword>void</span> <span class=hljs-title>add</span><span class=hljs-params>(<span class=hljs-keyword>int</span> a, <span class=hljs-keyword>int</span> b, Handler&lt;Integer&gt; resultHandler)</span> </span>{
    <span class=hljs-keyword>int</span> r = a + b;
    resultHandler.handle(r);
}</code></pre><p>Just to avoid misconceptions, asynchronous API are not about threads. As we can see in the <code>add</code> example, there are no threads involved.</p><h2 id=jdbc-yes-but-asynchronous>JDBC yes, but asynchronous</h2><p>So, now that we have seen some basics about asynchronous API, let’s have a look to the vertx-jdbc-client. This component lets us interact with a database through a JDBC driver. These interactions are asynchronous, so when you were doing:</p><pre><code class=hljs><span class=hljs-built_in>String</span> sql <span class=hljs-subst>=</span> <span class=hljs-string>"SELECT * FROM Products"</span>;
<span class=hljs-keyword>ResultSet</span> rs <span class=hljs-subst>=</span> stmt<span class=hljs-built_in>.</span>executeQuery(sql);</code></pre><p>it will be:</p><pre><code class=hljs>connection.query(<span class=hljs-string>"SELECT * FROM Products"</span>, <span class=hljs-literal>result</span> -&gt; {
        // <span class=hljs-keyword>do</span> something <span class=hljs-keyword>with</span> the <span class=hljs-literal>result</span>
});</code></pre><p>This model is more efficient as it avoids waiting for the result. You are notified when the result is available.</p><p>Let’s now modify our application to use a database to store our products.</p><h2 id=some-maven-dependencies>Some maven dependencies</h2><p>The first things we need to do it to declare two new Maven dependencies in our <code>pom.xml</code> file:</p><pre><code class=hljs><span class=hljs-tag>&lt;<span class=hljs-title>dependency</span>&gt;</span>
  <span class=hljs-tag>&lt;<span class=hljs-title>groupId</span>&gt;</span>io.vertx<span class=hljs-tag>&lt;/<span class=hljs-title>groupId</span>&gt;</span>
  <span class=hljs-tag>&lt;<span class=hljs-title>artifactId</span>&gt;</span>vertx-jdbc-client<span class=hljs-tag>&lt;/<span class=hljs-title>artifactId</span>&gt;</span>
  <span class=hljs-tag>&lt;<span class=hljs-title>version</span>&gt;</span>3.1.0<span class=hljs-tag>&lt;/<span class=hljs-title>version</span>&gt;</span>
<span class=hljs-tag>&lt;/<span class=hljs-title>dependency</span>&gt;</span>
<span class=hljs-tag>&lt;<span class=hljs-title>dependency</span>&gt;</span>
  <span class=hljs-tag>&lt;<span class=hljs-title>groupId</span>&gt;</span>org.hsqldb<span class=hljs-tag>&lt;/<span class=hljs-title>groupId</span>&gt;</span>
  <span class=hljs-tag>&lt;<span class=hljs-title>artifactId</span>&gt;</span>hsqldb<span class=hljs-tag>&lt;/<span class=hljs-title>artifactId</span>&gt;</span>
  <span class=hljs-tag>&lt;<span class=hljs-title>version</span>&gt;</span>2.3.3<span class=hljs-tag>&lt;/<span class=hljs-title>version</span>&gt;</span>
<span class=hljs-tag>&lt;/<span class=hljs-title>dependency</span>&gt;</span></code></pre><p>The first dependency provides the vertx-jdbc-client, while the second one provide the HSQL JDBC driver. If you want to use another database, change this dependency. You will also need to change the JDBC url and JDBC driver class name later.</p><h2 id=initializing-the-jdbc-client>Initializing the JDBC client</h2><p>Now that we have added these dependencies, it’s time to create our JDBC client:</p><p>In the <code>MyFirstVerticle</code> class, declare a new field <code>JDBCClient jdbc;</code>, and add the following line at the beginning of the <code>start</code> method:</p><pre><code class=hljs><span class=hljs-setting>jdbc = <span class=hljs-value>JDBCClient.createShared(vertx, config(), <span class=hljs-string>"My-Whisky-Collection"</span>);</span></span></code></pre><p>This creates an instance of JDBC client, configured with the configuration provided to the verticle. To work correctly this configuration needs to provide:</p><ul><li><em>url</em> - the JDBC url such as <code>jdbc:hsqldb:mem:db?shutdown=true</code></li><li>_driver_class_ - the JDBC driver class such as <code>org.hsqldb.jdbcDriver</code></li></ul><p>Ok, we have the client, we need a connection to the database. This is achieved using the <code>jdbc.getConnection</code> that take a <code>Handler&lt;AsyncResult&lt;SQLConnection&gt;&gt;</code> as parameter. Let’s have a deeper look to this type. It’s a <code>Handler</code>, so it is called when the result is ready. This result is an instance of <code>AsyncResult&lt;SQLConnection&gt;</code>. <code>AsyncResult</code> is a structure provided by vert.x that lets us know if the operation was completed successfully or failed. In case of success, it provides the result, here an instance of <code>SQLConnection</code>.</p><p>When you receive an instance of <code>AsyncResult</code>, your code generally looks like:</p><pre><code class=hljs><span class=hljs-keyword>if</span> (ar.failed()) {
  <span class=hljs-type>System</span>.err.println(<span class=hljs-string>"The operation has failed...: "</span>
      + ar.cause().getMessage());
} <span class=hljs-keyword>else</span> {
  // <span class=hljs-type>Use</span> the <span class=hljs-literal>result</span>:
  <span class=hljs-literal>result</span> = ar.<span class=hljs-literal>result</span>();
 }</code></pre><p>So, let’s go back to our <code>SQLConnection</code>. We need to retrieve it, and then start the rest of the application. This changes how we start the application, as it will become asynchronous. So, if we divide our startup sequence into small chunks it would be something like:</p><pre><code class=hljs>startBackend(
 <span class=hljs-function><span class=hljs-params>(connection)</span> -&gt;</span> createSomeData(connection,
     <span class=hljs-function><span class=hljs-params>(nothing)</span> -&gt;</span> startWebApp(
         <span class=hljs-function><span class=hljs-params>(http)</span> -&gt;</span> completeStartup(http, fut)
     ), fut
 ), fut);</code></pre><p>with:</p><ol><li><code>startBackend</code> - retrieves a <code>SQLConnection</code> and then calls the next step</li><li><code>createSomeData</code> - initializes the database and inserts some data. When done, it calls the next step</li><li><code>startWebApp</code> - starts our web application</li><li><code>completeStartup</code> - finalizes our start sequence</li></ol><p><code>fut</code> is the completion future passed by vert.x that let us report when we are started, or if an issue has been encountered while starting.</p><p>Let’s have a look to <code>startBackend</code>:</p><pre><code class=hljs>private <span class=hljs-type>void</span> startBackend(<span class=hljs-type>Handler</span>&lt;<span class=hljs-type>AsyncResult</span>&lt;<span class=hljs-type>SQLConnection</span>&gt;&gt; next, <span class=hljs-type>Future</span>&lt;<span class=hljs-type>Void</span>&gt; fut) {
    jdbc.getConnection(ar -&gt; {
      <span class=hljs-keyword>if</span> (ar.failed()) {
        fut.fail(ar.cause());
      } <span class=hljs-keyword>else</span> {
        next.handle(<span class=hljs-type>Future</span>.succeededFuture(ar.<span class=hljs-literal>result</span>()));
      }
    });
  }</code></pre><p>This method retrieves a <code>SQLConnection</code>, check whether this operation succeeded. If so, it calls the next step. In case of failure, it reports it.</p><p>The other methods follow the same pattern: 1) check if the last operation has succeeded, 2) do the task, 3) call the next step.</p><h3 id=a-bit-of-sql->A bit of SQL…</h3><p>Our client is ready, let’s now write some SQL statements. Let’s start by the <code>createSomeData</code> method that is part of the startup sequence:</p><pre><code class=hljs>private <span class=hljs-type>void</span> createSomeData(<span class=hljs-type>AsyncResult</span>&lt;<span class=hljs-type>SQLConnection</span>&gt; <span class=hljs-literal>result</span>,
    <span class=hljs-type>Handler</span>&lt;<span class=hljs-type>AsyncResult</span>&lt;<span class=hljs-type>Void</span>&gt;&gt; next, <span class=hljs-type>Future</span>&lt;<span class=hljs-type>Void</span>&gt; fut) {
    <span class=hljs-keyword>if</span> (<span class=hljs-literal>result</span>.failed()) {
      fut.fail(<span class=hljs-literal>result</span>.cause());
    } <span class=hljs-keyword>else</span> {
      <span class=hljs-type>SQLConnection</span> connection = <span class=hljs-literal>result</span>.<span class=hljs-literal>result</span>();
      connection.execute(
          <span class=hljs-string>"CREATE TABLE IF NOT EXISTS Whisky (id INTEGER IDENTITY, name varchar(100), "</span> +
          <span class=hljs-string>"origin varchar(100))"</span>,
          ar -&gt; {
            <span class=hljs-keyword>if</span> (ar.failed()) {
              fut.fail(ar.cause());
              connection.close();
              <span class=hljs-keyword>return</span>;
            }
            connection.query(<span class=hljs-string>"SELECT * FROM Whisky"</span>, select -&gt; {
              <span class=hljs-keyword>if</span> (select.failed()) {
                fut.fail(ar.cause());
                connection.close();
                <span class=hljs-keyword>return</span>;
              }
              <span class=hljs-keyword>if</span> (select.<span class=hljs-literal>result</span>().getNumRows() == <span class=hljs-number>0</span>) {
                insert(
                    new <span class=hljs-type>Whisky</span>(<span class=hljs-string>"Bowmore 15 Years Laimrig"</span>, <span class=hljs-string>"Scotland, Islay"</span>),
                    connection,
                    (v) -&gt; insert(new <span class=hljs-type>Whisky</span>(<span class=hljs-string>"Talisker 57° North"</span>, <span class=hljs-string>"Scotland, Island"</span>),
                        connection,
                        (r) -&gt; {
                          next.handle(<span class=hljs-type>Future</span>.&lt;<span class=hljs-type>Void</span>&gt;succeededFuture());
                          connection.close();
                        }));                                                    
              } <span class=hljs-keyword>else</span> {
                next.handle(<span class=hljs-type>Future</span>.&lt;<span class=hljs-type>Void</span>&gt;succeededFuture());
                connection.close();
              }
            });
          });
    }
  }</code></pre>This method checks that the `SQLConnection` is available and then start executing some SQL statements. First, it creates the tables if there are not there yet. As you can see, the method called is structured as follows:<pre><code class=hljs>connection.execute(
    SQL statement,
    <span class=hljs-operator><span class=hljs-keyword>handler</span> called <span class=hljs-keyword>when</span> the statement has been executed
)</span></code></pre><p>The handler receives an <code>AsyncResult&lt;Void&gt;</code>, <em>i.e.</em> a notification of the completion without an actual result.</p><p><div class="admonition-block note"><table><tbody><tr><td class=admonition-icon><i class="admonition-icon fa fa-comment"></i></td><td class=content><span class=title>Closing connection</span><br><span class=content>Don’t forget to close the SQL connection when you are done. The connection will be given back to the connection pool and be reused.</span></td></tr></tbody></table></div></p><p>In the code of this handler, we check whether or not the statement has been executed correctly, and if so we check to see if the table already contains some data, if not, it inserts data using the <code>insert</code> method:</p><pre><code class=hljs>private <span class=hljs-type>void</span> insert(<span class=hljs-type>Whisky</span> whisky, <span class=hljs-type>SQLConnection</span> connection, <span class=hljs-type>Handler</span>&lt;<span class=hljs-type>AsyncResult</span>&lt;<span class=hljs-type>Whisky</span>&gt;&gt; next) {
  <span class=hljs-type>String</span> sql = <span class=hljs-string>"INSERT INTO Whisky (name, origin) VALUES ?, ?"</span>;
  connection.updateWithParams(sql,
      new <span class=hljs-type>JsonArray</span>().add(whisky.getName()).add(whisky.getOrigin()),
      (ar) -&gt; {
        <span class=hljs-keyword>if</span> (ar.failed()) {
          next.handle(<span class=hljs-type>Future</span>.failedFuture(ar.cause()));
          <span class=hljs-keyword>return</span>;
        }
        <span class=hljs-type>UpdateResult</span> <span class=hljs-literal>result</span> = ar.<span class=hljs-literal>result</span>();
        // <span class=hljs-type>Build</span> a new whisky instance <span class=hljs-keyword>with</span> the generated id.
        <span class=hljs-type>Whisky</span> w = new <span class=hljs-type>Whisky</span>(<span class=hljs-literal>result</span>.getKeys().getInteger(<span class=hljs-number>0</span>), whisky.getName(), whisky.getOrigin());
        next.handle(<span class=hljs-type>Future</span>.succeededFuture(w));
      });
}</code></pre><p>This method uses the <code>updateWithParams</code> method with an <em>INSERT</em> statement, and pass values. This approach avoids SQL injection. Once the the statement has been executed, we creates a new <code>Whisky</code> object with the created (auto-generated) id.</p><h2 id=some-rest-with-a-pinch-of-sql>Some REST with a pinch of SQL</h2><p>The method described above is part of our start sequence. But what about the method invoked by our REST API. Let’s have a look to the <code>getAll</code> method. This method is called by the web front-end to retrieve all stored products:</p><pre><code class=hljs>private <span class=hljs-type>void</span> getAll(<span class=hljs-type>RoutingContext</span> routingContext) {
    jdbc.getConnection(ar -&gt; {
      <span class=hljs-type>SQLConnection</span> connection = ar.<span class=hljs-literal>result</span>();
      connection.query(<span class=hljs-string>"SELECT * FROM Whisky"</span>, <span class=hljs-literal>result</span> -&gt; {
        <span class=hljs-type>List</span>&lt;<span class=hljs-type>Whisky</span>&gt; whiskies = <span class=hljs-literal>result</span>.<span class=hljs-literal>result</span>().getRows().stream().map(<span class=hljs-type>Whisky</span>::new).collect(<span class=hljs-type>Collectors</span>.toList());
        routingContext.response()
            .putHeader(<span class=hljs-string>"content-type"</span>, <span class=hljs-string>"application/json; charset=utf-8"</span>)
            .<span class=hljs-keyword>end</span>(<span class=hljs-type>Json</span>.encodePrettily(whiskies));
        connection.close(); // <span class=hljs-type>Close</span> the connection        
      });
    });
  }</code></pre><p>This method gets a <code>SQLConnection</code>, and then issue a query. Once the result has been retrieved it writes the HTTP response as before. The <code>getOne</code>, <code>deleteOne</code>, <code>updateOne</code> and <code>addOne</code> methods follow the same pattern. Notice that the connection can be closed after the response has been written.</p><p>Let’s have a look to the result provided to the handler passed to the <code>query</code> method. It gets a <code>ResultSet</code>, which contains the query result. Each row is a <code>JsonObject</code>, so if your data object has a constructor taking a <code>JsonObject</code> as unique argument, creating there objects is straightforward.</p><h2 id=test-test-and-test-again>Test, test, and test again</h2><p>We need to slightly update our tests to configure the <code>JDBCClient</code>. In the <code>MyFirstVertilceTest</code> class, change the <code>DeploymentOption</code> object created in the <code>setUp</code> method to be:</p><pre><code class=hljs>DeploymentOptions <span class=hljs-keyword>options</span> = <span class=hljs-keyword>new</span> DeploymentOptions()
        .setConfig(<span class=hljs-keyword>new</span> JsonObject()
            .<span class=hljs-keyword>put</span>(<span class=hljs-string>"http.port"</span>, port)
            .<span class=hljs-keyword>put</span>(<span class=hljs-string>"url"</span>, <span class=hljs-string>"jdbc:hsqldb:mem:test?shutdown=true"</span>)
            .<span class=hljs-keyword>put</span>(<span class=hljs-string>"driver_class"</span>, <span class=hljs-string>"org.hsqldb.jdbcDriver"</span>)
        );</code></pre><p>In addition to the <code>http.port</code>, we also put the JDBC url and the class of the JDBC driver. We use an in-memory database for tests.</p><p>The same modification needs to be done in the <code>src/test/resources/my-it-config.json</code> file:</p><pre><code class=hljs>{
  <span class=hljs-string>"http.port"</span>: <span class=hljs-variable>${http.port}</span>,
  <span class=hljs-string>"url"</span>: <span class=hljs-string>"jdbc:hsqldb:mem:it-test?shutdown=true"</span>,
  <span class=hljs-string>"driver_class"</span>: <span class=hljs-string>"org.hsqldb.jdbcDriver"</span>
}</code></pre><p>The <code>src/main/conf/my-application-conf.json</code> file also needs to be updated, not for the tests, but to run the application:</p><pre><code class=hljs>{
  "<span class=hljs-attribute>http.port</span>" : <span class=hljs-value><span class=hljs-number>8082</span></span>,
  "<span class=hljs-attribute>url</span>": <span class=hljs-value><span class=hljs-string>"jdbc:hsqldb:file:db/whiskies"</span></span>,
  "<span class=hljs-attribute>driver_class</span>": <span class=hljs-value><span class=hljs-string>"org.hsqldb.jdbcDriver"</span>
</span>}</code></pre><p>The JDBC url is a bit different in this last file, as we store the database on the file system.</p><h2 id=show-time->Show time!</h2><p>Let’s now build our application:</p><p><code>mvn clean package</code></p><p>As we didn’t change the API (neither the public java one nor the REST), test should run smoothly.</p><p>Then launch the application with:</p><p><code>java -jar target/my-first-app-1.0-SNAPSHOT-fat.jar -conf src/main/conf/my-application-conf.json</code></p><p>Open your browser to <code>http://localhost:8082/assets/index.html</code>, and you should see the application using the database. This time the products are stored in a database persisted on the file system. So, if we stop and restart the application, the data is restored.</p><h2 id=conclusion>Conclusion</h2><p>In this post, we saw how you can use JDBC database with vert.x, and thus without too much burden. You may have been surprised by the asynchronous development model, but once you start using it, it’s hard to come back.</p><p>In the <a href="http://vertx.io/blog/combine-vert-x-and-mongo-to-build-a-giant/">next post</a>, we see how the same application can use mongoDB instead of HSQL.</p><p>Stay tuned, and happy coding !</p></article></article></div><div class=row><div class=col-xs-12 id=disqus_thread></div></div><script>var disqus_config = function () {
  this.page.url = "https://vertx.tk/blog/using-the-asynchronous-sql-client/";
  this.page.identifier = "/blog/using-the-asynchronous-sql-client/";
  };
  (function() { // DON'T EDIT BELOW THIS LINE
  var d = document, s = d.createElement('script');
  s.src = 'https://vertx.disqus.com/embed.js';
  s.setAttribute('data-timestamp', +new Date());
  (d.head || d.body).appendChild(s);
  })();</script><noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript></div><footer><div class=container><div class=row><div class="col-xs-4 col-sm-4 col-md-2 col-lg-2"><h2>Eclipse Vert.x</h2><ul class=list-unstyled><li><a href="https://vertx.tk/">主页</a></li><li><a href="https://vertx.tk/download/">下载</a></li><li><a href="https://vertx.tk/docs/">文档</a></li><li><a href=https://github.com/vert-x3/wiki/wiki>维基</a></li><li><a href="https://vertx.tk/blog/">博客</a></li></ul></div><div class="col-xs-4 col-sm-4 col-md-2 col-lg-2"><h2>Community</h2><ul class=list-unstyled><li><a href="https://vertx.tk/community/">帮助 &amp; 贡献者</a></li><li><a href="https://vertx.tk/materials/">学习资料</a></li><li><a href=https://groups.google.com/forum/?fromgroups#!forum/vertx>User Group</a></li><li><a href=https://groups.google.com/forum/?fromgroups#!forum/vertx-dev>Developer Group</a></li><li><a href="//shang.qq.com/wpa/qunwpa?idkey=587f58cacb9557e3291b46098e0fe09427b98a1c0f866da23c04c2762bc7e2ad">QQ群</a></li></ul></div><div class="col-xs-4 col-sm-4 col-md-2 col-lg-2"><h2>Eclipse</h2><ul class=list-unstyled><li><a href="http://www.eclipse.org/">Eclipse Foundation</a></li><li><a href=https://eclipse.org/legal/privacy.php>Privacy Policy</a></li><li><a href=https://eclipse.org/legal/termsofuse.php>Terms of Use</a></li><li><a href=https://eclipse.org/legal/copyright.php>Copyright Agent</a></li><li><a href=http://www.eclipse.org/legal>Legal Resources</a></li></ul></div><div class="col-xs-12 col-sm-12 col-md-6 col-lg-6 copyright"><p>Eclipse Vert.x is open source and dual-licensed under the <a href=http://www.eclipse.org/legal/epl-v20.html>Eclipse Public License 2.0</a> and <a href=https://www.apache.org/licenses/LICENSE-2.0.html>Apache License 2.0</a>.</p><p>This website is licensed under the <a href="http://creativecommons.org/licenses/by-sa/3.0/">CC BY-SA 3.0 License</a>.<br>Design by <a href=https://www.michel-kraemer.com>Michel Kr&auml;mer</a>.</p><div class=row><div class="col-sm-12 col-md-5 col-md-offset-1 col-lg-offset-2"><a href=http://eclipse.org><img class="logo eclipse-logo" src=https://vertx.tk/assets/eclipse_logo_grey_small.png width=204 height=48></a></div><div class="col-sm-12 col-md-5 col-md-offset-1 col-lg-offset-0"><a href=http://cloudbees.com><img class="logo cloudbees-logo" src=https://vertx.tk/assets/Button-Built-on-CB-1-grey.png width=180 height=48></a></div><div class="col-sm-12 col-md-5 col-md-offset-7 jprofiler"><a href=http://www.ej-technologies.com/products/jprofiler/overview.html style=text-decoration:none><img class="logo jprofiler-logo" src=https://vertx.tk/assets/jprofiler-logo.png width=48 height=48><span class=jprofiler-logo>&nbsp; JPROFILER</span></a></div></div></div></div></div></footer><script src=https://cdnjs.cloudflare.com/ajax/libs/jquery/1.9.1/jquery.min.js></script><script src=https://vertx.tk/javascripts/bootstrap.min.js></script><script src=https://vertx.tk/javascripts/highlight.pack.js></script><script>hljs.initHighlightingOnLoad();</script><link rel=stylesheet type=text/css href="//cdnjs.cloudflare.com/ajax/libs/cookieconsent2/3.0.3/cookieconsent.min.css"><script src=//cdnjs.cloudflare.com/ajax/libs/cookieconsent2/3.0.3/cookieconsent.min.js></script><script>window.addEventListener("load", function(){
window.cookieconsent.initialise({
  "palette": {
    "popup": {
      "background": "#64386b",
      "text": "#ffcdfd"
    },
    "button": {
      "background": "transparent",
      "text": "#f8a8ff",
      "border": "#f8a8ff"
    }
  },
  "content": {
    "message": "This website uses anonymous cookies to ensure we provide you the best experience. ",
    "link": "Opt out!",
    "href": "https://tools.google.com/dlpage/gaoptout/"
  }
})});</script></body></html>